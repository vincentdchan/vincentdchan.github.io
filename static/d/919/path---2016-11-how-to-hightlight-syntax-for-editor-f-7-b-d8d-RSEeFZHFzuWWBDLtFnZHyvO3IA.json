{"data":{"markdownRemark":{"html":"<p>最近正在尝试造一个Markdown编辑器的轮子 <a href=\"https://github.com/vincentdchan/MDE\">MDE</a> 现在算是实现了简单的数据结构，用 chains of lines实现了，支持插入，删除，替换操作。</p>\n<p>至于 Model 至视图（View）层面的更新就简单了，只要判断出插入、删除的那几行，去更新 DOM 里面那几行就可以了，也可以说是非常简单。</p>\n<p>目前比较棘手的一个问题是给 <strong>Syntax Highlighting</strong>。Syntax Highlighting 是编辑器很重要的一部分。因为它需要速度非常快，必须在输入瞬间就完成，这样不会给用户发现有卡顿。而且它必须在输入瞬间完成。我想过一种做法就是，先显示没有着色的文本，然后在后台进行着色，然后再更新视图(View)。但是我觉得这样的做法就体验非常差了，用户输入的时候，文本没有被着色，而是等一段时间才有，会让人觉得非常不流畅。所以 Syntax Highlighting 必须再用户输入的瞬间完成。另外，我用很多基于Web的编辑器(Atom, Typora)都觉得不如 Native 的（Sublime Text）之类的来得快，这样就造成了体验不好，所以我写的 Syntax Highlighting 必须要快。</p>\n<p>我的编辑器只支持 Markdown 语法，按道理来说 Markdown 语法（包含HTML）是属于<strong>有限自动机（Finite-State）</strong>语法，也就是说，只要写Lexer(Tokenizer)就好了。</p>\n<p>如果这样想的话，就简单了，有限自动机语法直接用<strong>正则表达式（Regular Expression）</strong>做就好了，如果一行有更新，就对这一行进行<strong>重新 Tokenize</strong>，然后再更新视图（View），一行来说一不会超过 50 个字，如果是 DFA 的话，速度会很快，基本不用担心速度问题，即使是正则表达式也不会慢多少，但是这就有一个问题，就是换行的问题。</p>\n<pre><code class=\"language-html\">&#x3C;div\nid = \"name\">&#x3C;/div>\n</code></pre>\n<p>因为 Markdown 语法是兼容 HTML 的，假设，我们有一句 html，它的 tag 在第 n 行，它的 attribute在第 n+1，如果我们只对一行做正则表达式，那么第 n+1 行的 attribute 就无法感知上一行的改变了。另一方面，在上面得例子第二行上面加上<code>&#x3C;div></code>这样一行，下面的语法高亮都会有所不同。那是否意味着，我们每一次改变，都要对整个文本进行 tokenize 呢？当然这样肯定是不切实际的，上面说过，语法高亮必须是实时的，这样才能保证好的用户体验，但是 Syntax Highting 依然与上下文有关。这里我们可以采用 CodeMirror 的做法了： 每一行保存一个 state</p>\n<p>我们刚才说到，Syntax Highting 需要用到上下文的信息，那么我们可以为每一行保存一个 state。当我们对当前行进行 high lighting 的时候，就可以使用前一行的 state 的。仍然用回上面的例子，第一行里面我们 tokenize 了，进入了一个state 这个 state 告诉我们这个 tag 还没有定义完，例如 <code>state.finishTag = false</code>  当我们第二行修改的时候，就可以利用上一行的 state，得知我们仍在一个tag里面，这样，第二行的 attribute 就可以正确着色了。第二行完成了 tag 之后 <code>state.finishTag = true</code></p>\n<p>仍然用回上面的例子，我们知道，如果某一行的 state 改变了，下面所有的内容都必须进行重新 tokenize，但是我们可以考虑下一下，第 n 行被修改了，那么下文的修改其实不需要实时进行修改，我们可以把这个工作交给后台，用别的 process 或者 thread 进行，完成以后再更新视图，我们只需要保证当前行的着色是实时的就可以了。</p>","frontmatter":{"date":"2016-11-06T13:06:00.000Z","path":null,"title":"如何实现编辑器文本语法高亮着色","permalink":"how-to-hightlight-syntax-for-editor","headerImage":null}},"headerImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAT/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAFOEQP/xAAZEAABBQAAAAAAAAAAAAAAAAABAAIDETL/2gAIAQEAAQUCoCB+F//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAABEQ/9oACAEBAAY/Akv/xAAZEAEAAwEBAAAAAAAAAAAAAAABABExUYH/2gAIAQEAAT8hqKF2LfsF7P/aAAwDAQACAAMAAAAQ8A//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEAAwEBAAAAAAAAAAAAAAABABExUUH/2gAIAQEAAT8QLSDT0aiKQZQ55AWC3s//2Q==","tracedSVG":"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='400' height='84' viewBox='0 0 400 84' version='1'%3e%3cpath d='M0 42v42h18v-6c1-4 1-6 3-8l3-3 2-5c2-3 2-6 2-14 0-10 0-10 3-13l2-3c1-1 11-12 15-14l5-2 3-1 1-2 3-2c1-2 3-3 5-3 1 0 5-5 5-8H0v42M91 2c0 2 5 4 6 3l1 3 1 4h5l2-3 3-3h1l1-2c-1-1 0-2 1-3s0-1-10-1-11 0-11 2m32 0c0 2 0 2-2 2l-4 2c-2 2-2 2-1 3l2 2 1 2c2 0 3 3 2 3l-3-3c-2-3-4-4-6-1-2 1-2 2-1 4v3c-5 0-4 6 1 7l10 7v2c0 2 5 3 8 1 5-2 5 0 0 3-6 3-7 5-6 8l-1 5v2c3 0 4-1 4-3l1-4c1-1 1-1 1 2-1 4-1 4 6-3 6-6 6-6 0-11-1-1 0-2 4-6 3-5 4-6 3-8l-1-2c-2 1-4 0-4-3-1-3-1-3-2-2s-1 1-2-1c-3-3-3-6 0-4 1 1 1 1 1-1 0-3-3-9-3-7-1 2-7 2-7 0-1-1-1-1-1 1m26 0c2 3 3 4 4 2 1-1 1-1 3 1l4 3 1 2 1 4v3l-1 3-1 2-2-1c1-3 0-5-2-5-3 0-16 14-14 15 2 2 9 2 11 0s2-2 3-1c1 2 2 1 2-1v-3h7l2 1 1-1v-6c-1-2 0-5 2-4l1-1c0-3 2-2 2 0l2 3 1 4 2 2c1 0 2-1 2-4l1-4c3 0 2-2-1-5-2-2-4-4-3-5 0-1-5-2-7-1l-2 3c1 1 0 1-1 1l-2-1c0-5-12-11-12-6h-2c-2-3-3-2-2 0m93 1l3 5 3 23c0 3 0 4 3 3 3 0 3 0 3-5l-1-5c-2 0-4-4-3-6 1-1 0-2-1-3l-1-9V0h-8l2 3m17-1l2 6v22c1 9 3 11 7 14l4 3 5 1c4 0 5 0 4 2l2 5c2 2 2 8-2 14v3l-2 2c-2 2-2 2 0 3 2 0 6 5 6 6l58 1h57V0h-13c-13 0-13 0-13 2l-1 3V2l-1-2h-39c-37 0-38 0-40 2-2 3-4 3-5 0 0-3-29-3-29 0m29 5l-3 1c-2 0-2 0-2 5 0 4 1 4 3 4l2 1 1 1 1-1 2-3c2-2 3-6 0-8-2-2-3-2-4 0m-79 7c-3 3-2 5 1 6 5 0 8 4 7 9l-1 4v-5l-1-4v1c1 2-2 7-5 7-2 0-6 6-5 9l-1 4c-1 1-1 1-2-1-1-3-4-4-8-4l-4-1-2-1 1 2v1c-3 1-2 3 0 4h2a424 424 0 0 0 4 8c0 2 8 8 10 8l3 1c1 1 6 0 7-2l-2-3c-8-2-11-4-10-6v-3l2 2 7 3 6 2c1 2 1 2 4-4l2-4-3-3c-2-2-3-3-2-5 0-5 3-12 4-12l1-1-1-2-1-3c2-7 0-9-5-10-4 0-6 1-8 3m-17 51c1 11 1 13-1 14-1 0-2 0-2-2l-2-3-2-3c-1-2-2-2-4-2l-7 5-12 3-19-7c-7-3-9-3-10-2 0 2-1 2-5 0-4-1-4-1-6 1-1 1-2 3-4 3-2 1-2 1 3 3 7 2 12 5 12 7 0 1 3 2 24 2 23 0 24 0 23-2 0-3 4-3 5 0l1 2 1-2 1-2 1 2c0 2 1 2 5 2s5-1 9-8c1-2-2-4-5-4-3 1-3 1 0-3 1-1 2-3 1-4l-3-1-3-3-2-2 1 6m64 2l-2 1-2 4c-2 1-3 3-2 4v3l2 1 4 2c1 2 7 3 8 1v-3c-2-2-2-5-1-5 2 0 1-6 0-8h-7' fill='lightgray' fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":4.751219512195122,"src":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/8484e/new-worlds.jpg","srcSet":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/6ad16/new-worlds.jpg 200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8f1ca/new-worlds.jpg 400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8484e/new-worlds.jpg 800w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/150f3/new-worlds.jpg 1200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/bea14/new-worlds.jpg 1600w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/67033/new-worlds.jpg 2400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/96ae4/new-worlds.jpg 4870w","srcWebp":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/765ea/new-worlds.webp","srcSetWebp":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/05ec5/new-worlds.webp 200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8cb0a/new-worlds.webp 400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/765ea/new-worlds.webp 800w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/dd093/new-worlds.webp 1200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/ccbd9/new-worlds.webp 1600w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/db648/new-worlds.webp 2400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/1ac8a/new-worlds.webp 4870w","sizes":"(max-width: 800px) 100vw, 800px","originalImg":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/96ae4/new-worlds.jpg","originalName":"new-worlds.jpg","presentationWidth":800,"presentationHeight":168}}}},"pageContext":{"title":"如何实现编辑器文本语法高亮着色"}}