{"data":{"markdownRemark":{"html":"<p>刚开始写这个编辑器的时候，我是毫无思路的，就是完全不知道如何下手，后来去翻了一下 CodeMirror, ACEditor, VSCode 这些优秀编辑器的代码，但是我没有全看，因为我要我的编辑器大部分都是我自己想出来的，只有我想不到的时候才去看。\n首先我们需要一个数据结构来储存我们的文本，为什么要用数据结构而不直接用 string，是因为编辑器需要大量的增删查改操作，而当一个文本很大的时候，string 是不够快的，因为 string 的增删查改操作的时间复杂度基本上都是 O(n)，还不够快。</p>\n<h1>数据结构 Data structure</h1>\n<p>一开始我打算用的是 Rope，是因为看上这个数据结构足够快，后来弃用了，是因为它和我的编辑器的 View 部分的构想不太一样，很难融合在一起，另外就是它本身自己也比较难实现，所以我就用了很简单的 chains of lines 来实现了，就是用一个数组，里面存的是每一行的内容。废话不多说先上代码</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/model/textModel.ts\">/src/model/textModel.ts</a></p>\n<pre><code class=\"language-typescript\">class TextModel {\n\n    protected _lines : LineModel[];\n\n    constructor(_string: string) {\n        // ctor\n    }\n\n    // other methods\n}\n</code></pre>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/model/lineModel.ts\">/src/model/lineModel.ts</a></p>\n<pre><code class=\"language-typescript\">class LineModel {\n\n    protected _number : number;\n    protected _text : string;\n\n    constructor(_num : number, _t : string) {\n        // ctor\n    }\n\n    // other methods\n}\n</code></pre>\n<p>数据结构就是这么简单，就是用数组把每一行的内容都存起来存起来。在这里我用了一个 LineModel 的类来储存，是因为我还要实现一些别的方法，比如最典型的增删操作。当然我们实际上要实现的数据结构的操作不止那么多，至少要把insert, delete, replace这几个操作都实现了才行。这样我们文中所有的字符都可以用一个对象 Position 来表示，就是行+位移</p>\n<pre><code class=\"language-typescript\">export interface Position {\n    line : number;\n    offset : number;\n}\n</code></pre>\n<p>而一段文字，也就是我们说的 Range，或者说选区（Selection）则可以用两个Position 来表示：</p>\n<pre><code class=\"language-typescript\">export interface Range {\n    begin: Position;\n    end: Position;\n}\n</code></pre>\n<p>想想我们要做编辑器要做的操作</p>\n<p>1.插入（Insert）: 在文本内的一个位置（Position）插入一段文字（string）</p>\n<p>2.删除（Delete）: 删除掉一段范围（Range）内的文字</p>\n<p>3.替换（Replace）: 把一段范围（Range）内的文字替换为一段新的文字（string）</p>\n<p><samll>其实替换操作很容易理解，我们先删除，再插入即可，所以我们主要实现 Insert 和 Delete。具体的实现方法可以参考我的源码</small></p>\n<h1>展现 Presentation</h1>\n<p>下面讲讲如何展现（presentation)，就是如何通过 HTML DOM 操作把数据结构里面的数据展现出来，我想大家都已经想到了，一个 LineModel 对应一行，一个父 DOM 包含着每一行的 DOM</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fbbaf443f03da85035ccb2a80b3965f1/b1413/screen-present.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 20.75242718446602%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwUlEQVQI1y2OO08DMRCE7///FyqkFDRpgCBER4GQUoUkyt2e7fXa+/A9OFYK0mg0xXya6b4+j8/7w8v+9XQ8KQpB5mzWtta2MVBhHYHPPzmODCAx2jAogLqLLN3h4/th9/b49H69hLltwovKarZNDo9UxUpSHFLChklKLs4TTTlPLHOHqCy/PqW21rqwLE7+w4GwqlDDQESGWRKy90udvaZt7WLkEIrLgwtR7vD9dmXFKNcLBShDXwHsdpO+F3fm+Q8Dl+CmDoAFMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"screen present\"\n        title=\"\"\n        src=\"/static/fbbaf443f03da85035ccb2a80b3965f1/84ad3/screen-present.png\"\n        srcset=\"/static/fbbaf443f03da85035ccb2a80b3965f1/687da/screen-present.png 175w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/0ab4d/screen-present.png 350w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/84ad3/screen-present.png 700w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/ef8d3/screen-present.png 1050w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/fed13/screen-present.png 1400w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/5b79c/screen-present.png 2100w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/b1413/screen-present.png 2472w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n  </span>\n  </a></p>\n<p>看图可知，MDE 里面每一行其实就是一个 &#x3C;p>，所以其实没什么神秘的东西，不过就是加上了行号，还有 Syntax Highlighting 而已（这个我们后面会说）。怎么把上面提到的 TextModel 编程 HTML DOM 元素了，自己写个遍历器遍历一遍就好了，在这里不推荐自己拼接 HTML 字符然后用 innerHTML 更新，这样一来效率低下，二来需要手动过滤字符，三来不方便我们后续的更新。</p>\n<p>遍历一遍 TextModel，然后用 document.createElement 好了，这里你可能需要一个方便的工具类</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/util/dom.ts\">/src/util/dom.ts</a></p>\n<pre><code class=\"language-typescript\">function elem(elemName : string, className?: string, props?: any) {\n    let _elm = document.createElement(elemName);\n\n    if (className)\n        _elm.setAttribute(\"class\", className);\n\n    if (props &#x26;&#x26; typeof props === \"object\") {\n        for (let key in props) {\n            _elm.setAttribute(key, props[key]);\n        }\n    }\n\n    return _elm;\n}\n</code></pre>\n<p>具体的实现大家可以参考下列几个文件，不过因为已经实现了 Syntax Highlighting，可能现在的版本已经很复杂了，初学的话看可能有点压力</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/view/viewLine.ts\">/src/view/viewLine.ts</a></p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/view/viewDocument.ts\">/src/view/viewDocument.ts</a></p>\n<p>到现在为止，你可能已经知道怎么把 TextModel 里面的内容展现出来了，但是做一个编辑器，仅仅这样还是不够的，下一张讲讲如何更新视图。</p>","frontmatter":{"date":"2017-01-03T10:26:00.000Z","path":null,"title":"如何从头打造一个 Markdown 编辑器（一）：数据结构和展现","permalink":"markdown-editor-1","headerImage":null}},"headerImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAT/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAFOEQP/xAAZEAABBQAAAAAAAAAAAAAAAAABAAIDETL/2gAIAQEAAQUCoCB+F//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAABEQ/9oACAEBAAY/Akv/xAAZEAEAAwEBAAAAAAAAAAAAAAABABExUYH/2gAIAQEAAT8hqKF2LfsF7P/aAAwDAQACAAMAAAAQ8A//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEAAwEBAAAAAAAAAAAAAAABABExUUH/2gAIAQEAAT8QLSDT0aiKQZQ55AWC3s//2Q==","tracedSVG":"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='400' height='84' viewBox='0 0 400 84' version='1'%3e%3cpath d='M0 42v42h18v-6c1-4 1-6 3-8l3-3 2-5c2-3 2-6 2-14 0-10 0-10 3-13l2-3c1-1 11-12 15-14l5-2 3-1 1-2 3-2c1-2 3-3 5-3 1 0 5-5 5-8H0v42M91 2c0 2 5 4 6 3l1 3 1 4h5l2-3 3-3h1l1-2c-1-1 0-2 1-3s0-1-10-1-11 0-11 2m32 0c0 2 0 2-2 2l-4 2c-2 2-2 2-1 3l2 2 1 2c2 0 3 3 2 3l-3-3c-2-3-4-4-6-1-2 1-2 2-1 4v3c-5 0-4 6 1 7l10 7v2c0 2 5 3 8 1 5-2 5 0 0 3-6 3-7 5-6 8l-1 5v2c3 0 4-1 4-3l1-4c1-1 1-1 1 2-1 4-1 4 6-3 6-6 6-6 0-11-1-1 0-2 4-6 3-5 4-6 3-8l-1-2c-2 1-4 0-4-3-1-3-1-3-2-2s-1 1-2-1c-3-3-3-6 0-4 1 1 1 1 1-1 0-3-3-9-3-7-1 2-7 2-7 0-1-1-1-1-1 1m26 0c2 3 3 4 4 2 1-1 1-1 3 1l4 3 1 2 1 4v3l-1 3-1 2-2-1c1-3 0-5-2-5-3 0-16 14-14 15 2 2 9 2 11 0s2-2 3-1c1 2 2 1 2-1v-3h7l2 1 1-1v-6c-1-2 0-5 2-4l1-1c0-3 2-2 2 0l2 3 1 4 2 2c1 0 2-1 2-4l1-4c3 0 2-2-1-5-2-2-4-4-3-5 0-1-5-2-7-1l-2 3c1 1 0 1-1 1l-2-1c0-5-12-11-12-6h-2c-2-3-3-2-2 0m93 1l3 5 3 23c0 3 0 4 3 3 3 0 3 0 3-5l-1-5c-2 0-4-4-3-6 1-1 0-2-1-3l-1-9V0h-8l2 3m17-1l2 6v22c1 9 3 11 7 14l4 3 5 1c4 0 5 0 4 2l2 5c2 2 2 8-2 14v3l-2 2c-2 2-2 2 0 3 2 0 6 5 6 6l58 1h57V0h-13c-13 0-13 0-13 2l-1 3V2l-1-2h-39c-37 0-38 0-40 2-2 3-4 3-5 0 0-3-29-3-29 0m29 5l-3 1c-2 0-2 0-2 5 0 4 1 4 3 4l2 1 1 1 1-1 2-3c2-2 3-6 0-8-2-2-3-2-4 0m-79 7c-3 3-2 5 1 6 5 0 8 4 7 9l-1 4v-5l-1-4v1c1 2-2 7-5 7-2 0-6 6-5 9l-1 4c-1 1-1 1-2-1-1-3-4-4-8-4l-4-1-2-1 1 2v1c-3 1-2 3 0 4h2a424 424 0 0 0 4 8c0 2 8 8 10 8l3 1c1 1 6 0 7-2l-2-3c-8-2-11-4-10-6v-3l2 2 7 3 6 2c1 2 1 2 4-4l2-4-3-3c-2-2-3-3-2-5 0-5 3-12 4-12l1-1-1-2-1-3c2-7 0-9-5-10-4 0-6 1-8 3m-17 51c1 11 1 13-1 14-1 0-2 0-2-2l-2-3-2-3c-1-2-2-2-4-2l-7 5-12 3-19-7c-7-3-9-3-10-2 0 2-1 2-5 0-4-1-4-1-6 1-1 1-2 3-4 3-2 1-2 1 3 3 7 2 12 5 12 7 0 1 3 2 24 2 23 0 24 0 23-2 0-3 4-3 5 0l1 2 1-2 1-2 1 2c0 2 1 2 5 2s5-1 9-8c1-2-2-4-5-4-3 1-3 1 0-3 1-1 2-3 1-4l-3-1-3-3-2-2 1 6m64 2l-2 1-2 4c-2 1-3 3-2 4v3l2 1 4 2c1 2 7 3 8 1v-3c-2-2-2-5-1-5 2 0 1-6 0-8h-7' fill='lightgray' fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":4.751219512195122,"src":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/8484e/new-worlds.jpg","srcSet":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/6ad16/new-worlds.jpg 200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8f1ca/new-worlds.jpg 400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8484e/new-worlds.jpg 800w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/150f3/new-worlds.jpg 1200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/bea14/new-worlds.jpg 1600w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/67033/new-worlds.jpg 2400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/96ae4/new-worlds.jpg 4870w","srcWebp":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/765ea/new-worlds.webp","srcSetWebp":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/05ec5/new-worlds.webp 200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/8cb0a/new-worlds.webp 400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/765ea/new-worlds.webp 800w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/dd093/new-worlds.webp 1200w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/ccbd9/new-worlds.webp 1600w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/db648/new-worlds.webp 2400w,\n/static/02c8b40bb175bb1dbcf2bd5d46593c48/1ac8a/new-worlds.webp 4870w","sizes":"(max-width: 800px) 100vw, 800px","originalImg":"/static/02c8b40bb175bb1dbcf2bd5d46593c48/96ae4/new-worlds.jpg","originalName":"new-worlds.jpg","presentationWidth":800,"presentationHeight":168}}}},"pageContext":{"title":"如何从头打造一个 Markdown 编辑器（一）：数据结构和展现"}}