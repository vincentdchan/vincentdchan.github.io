{"componentChunkName":"component---src-templates-blog-template-js","path":"/2018/10/在-Mojave-下编译-SpiderMonkey","webpackCompilationHash":"7e2a1be1f9f81dd234f1","result":{"data":{"markdownRemark":{"html":"<p>自从 macOS 升级到 Mojave(10.14) 之后，编译 SpiderMonkey 变得有点不同。</p>\n<p>有一点比较重要的变化是 libstdc++ 被替换成 libc++，这个修改是从 OS X 10.9 就开始有的修改，所以直接调用 ./configure 有这样的 warning 和报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">checking whether the C++ compiler <span class=\"token punctuation\">(</span>/usr/bin/clang++  -fno-common -fno-rtti  -lobjc<span class=\"token punctuation\">)</span> actually is a C++ compiler<span class=\"token punctuation\">..</span>. no\nconfigure: error: /usr/bin/clang++  -fno-common -fno-rtti  -lobjc failed to compile and <span class=\"token function\">link</span> a simple C++ source.\n------ config.log ------\n<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\nconfigure:7837: checking <span class=\"token keyword\">for</span> <span class=\"token number\">64</span>-bit OS\nconfigure:7846: /usr/bin/clang -c  -std<span class=\"token operator\">=</span>gnu99 -Qunused-arguments  conftest.c <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;5</span>\nconfigure:8119: checking <span class=\"token keyword\">for</span> -framework ExceptionHandling\nconfigure:8129: /usr/bin/clang -o conftest  -std<span class=\"token operator\">=</span>gnu99 -fno-common -Qunused-arguments   -lobjc -framework ExceptionHandling conftest.c  <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;5</span>\nconfigure:8151: checking <span class=\"token keyword\">for</span> -dead_strip option to ld\nconfigure:8162: /usr/bin/clang -o conftest  -std<span class=\"token operator\">=</span>gnu99 -fno-common -Qunused-arguments   -lobjc -Wl,-dead_strip conftest.c  <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;5</span>\nconfigure:9034: checking <span class=\"token keyword\">for</span> valid debug flags\nconfigure:9045: /usr/bin/clang -c  -std<span class=\"token operator\">=</span>gnu99 -fno-common -g -Qunused-arguments  conftest.c <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;5</span>\nconfigure:9134: checking whether the C++ compiler <span class=\"token punctuation\">(</span>/usr/bin/clang++  -fno-common -fno-rtti  -lobjc<span class=\"token punctuation\">)</span> actually is a C++ compiler\nconfigure:9153: /usr/bin/clang++ -o conftest  -fno-common -fno-rtti -Qunused-arguments   -lobjc conftest.C  <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;5</span>\nclang: warning: libstdc++ is deprecated<span class=\"token punctuation\">;</span> move to libc++ with a minimum deployment target of OS X <span class=\"token number\">10.9</span> <span class=\"token punctuation\">[</span>-Wdeprecated<span class=\"token punctuation\">]</span>\nwarning: include path <span class=\"token keyword\">for</span> stdlibc++ headers not found<span class=\"token punctuation\">;</span> pass <span class=\"token string\">'-std=libc++'</span> on the <span class=\"token builtin class-name\">command</span> line to use the libc++ standard library instead <span class=\"token punctuation\">[</span>-Wstdlibcxx-not-found<span class=\"token punctuation\">]</span>\nconfigure:9147:10: fatal error: <span class=\"token string\">'new'</span> <span class=\"token function\">file</span> not found\n<span class=\"token comment\">#include &lt;new></span>\n         ^~~~~\n<span class=\"token number\">1</span> warning and <span class=\"token number\">1</span> error generated.\nconfigure: failed program was:\n<span class=\"token comment\">#line 9146 \"configure\"</span>\n<span class=\"token comment\">#include \"confdefs.h\"</span>\n<span class=\"token comment\">#include &lt;new></span>\nint <span class=\"token function-name function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\nint *foo <span class=\"token operator\">=</span> new int<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\nconfigure: error: /usr/bin/clang++  -fno-common -fno-rtti  -lobjc failed to compile and <span class=\"token function\">link</span> a simple C++ source.</code></pre></div>\n<p>很明显，报错原因是因为标准库 new 找不到，原因也在于 libstdc++ 被替换了，但是天杀的报错信息写错了。应该加入的 flag 是 <code class=\"language-text\">-stdlib=libc++</code> 而不是 <code class=\"language-text\">-std=libc++</code>，这一点很坑爹。</p>\n<p>但是加上了这个 flag 仍然不能编译，因为又有报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">clang: error: invalid deployment target <span class=\"token keyword\">for</span> -stdlib<span class=\"token operator\">=</span>libc++ <span class=\"token punctuation\">(</span>requires OS X <span class=\"token number\">10.7</span> or later<span class=\"token punctuation\">)</span></code></pre></div>\n<p>想了半天，我的系统不是 10.14 吗，后来才知道是因为要设置 deployment target，很坑爹，所以最后让我编译成功的命令是：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token assign-left variable\">CXXFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-stdlib=libc++ -mmacosx-version-min=10.7\"</span></code></pre></div>\n<p>写篇 blog 庆祝一下。</p>","frontmatter":{"date":"2018-10-29T00:16:14.000Z","path":"/2018/10/在-Mojave-下编译-SpiderMonkey","title":"在 Mojave 下编译 SpiderMonkey","permalink":null,"headerImage":null,"tags":["macOS","mojave","javescript","spidermonkey","mozilla"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"在 Mojave 下编译 SpiderMonkey"}}}