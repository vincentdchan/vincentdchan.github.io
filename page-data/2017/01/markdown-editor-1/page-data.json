{"componentChunkName":"component---src-templates-blog-template-js","path":"/2017/01/markdown-editor-1","webpackCompilationHash":"1bb9ac4a768d106a0e1d","result":{"data":{"markdownRemark":{"html":"<p>刚开始写这个编辑器的时候，我是毫无思路的，就是完全不知道如何下手，后来去翻了一下 CodeMirror, ACEditor, VSCode 这些优秀编辑器的代码，但是我没有全看，因为我要我的编辑器大部分都是我自己想出来的，只有我想不到的时候才去看。\n首先我们需要一个数据结构来储存我们的文本，为什么要用数据结构而不直接用 string，是因为编辑器需要大量的增删查改操作，而当一个文本很大的时候，string 是不够快的，因为 string 的增删查改操作的时间复杂度基本上都是 O(n)，还不够快。</p>\n<h1>数据结构 Data structure</h1>\n<p>一开始我打算用的是 Rope，是因为看上这个数据结构足够快，后来弃用了，是因为它和我的编辑器的 View 部分的构想不太一样，很难融合在一起，另外就是它本身自己也比较难实现，所以我就用了很简单的 chains of lines 来实现了，就是用一个数组，里面存的是每一行的内容。废话不多说先上代码</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/model/textModel.ts\">/src/model/textModel.ts</a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TextModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">protected</span> _lines <span class=\"token operator\">:</span> LineModel<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_string<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ctor</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// other methods</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/model/lineModel.ts\">/src/model/lineModel.ts</a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LineModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">protected</span> _number <span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">protected</span> _text <span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_num <span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> _t <span class=\"token operator\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ctor</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// other methods</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>数据结构就是这么简单，就是用数组把每一行的内容都存起来存起来。在这里我用了一个 LineModel 的类来储存，是因为我还要实现一些别的方法，比如最典型的增删操作。当然我们实际上要实现的数据结构的操作不止那么多，至少要把insert, delete, replace这几个操作都实现了才行。这样我们文中所有的字符都可以用一个对象 Position 来表示，就是行+位移</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Position</span> <span class=\"token punctuation\">{</span>\n    line <span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    offset <span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>而一段文字，也就是我们说的 Range，或者说选区（Selection）则可以用两个Position 来表示：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Range</span> <span class=\"token punctuation\">{</span>\n    begin<span class=\"token operator\">:</span> Position<span class=\"token punctuation\">;</span>\n    end<span class=\"token operator\">:</span> Position<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>想想我们要做编辑器要做的操作</p>\n<p>1.插入（Insert）: 在文本内的一个位置（Position）插入一段文字（string）</p>\n<p>2.删除（Delete）: 删除掉一段范围（Range）内的文字</p>\n<p>3.替换（Replace）: 把一段范围（Range）内的文字替换为一段新的文字（string）</p>\n<p><samll>其实替换操作很容易理解，我们先删除，再插入即可，所以我们主要实现 Insert 和 Delete。具体的实现方法可以参考我的源码</small></p>\n<h1>展现 Presentation</h1>\n<p>下面讲讲如何展现（presentation)，就是如何通过 HTML DOM 操作把数据结构里面的数据展现出来，我想大家都已经想到了，一个 LineModel 对应一行，一个父 DOM 包含着每一行的 DOM</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fbbaf443f03da85035ccb2a80b3965f1/b1413/screen-present.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 20.75242718446602%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwUlEQVQI1y2OO08DMRCE7///FyqkFDRpgCBER4GQUoUkyt2e7fXa+/A9OFYK0mg0xXya6b4+j8/7w8v+9XQ8KQpB5mzWtta2MVBhHYHPPzmODCAx2jAogLqLLN3h4/th9/b49H69hLltwovKarZNDo9UxUpSHFLChklKLs4TTTlPLHOHqCy/PqW21rqwLE7+w4GwqlDDQESGWRKy90udvaZt7WLkEIrLgwtR7vD9dmXFKNcLBShDXwHsdpO+F3fm+Q8Dl+CmDoAFMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"screen present\"\n        title=\"\"\n        src=\"/static/fbbaf443f03da85035ccb2a80b3965f1/84ad3/screen-present.png\"\n        srcset=\"/static/fbbaf443f03da85035ccb2a80b3965f1/687da/screen-present.png 175w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/0ab4d/screen-present.png 350w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/84ad3/screen-present.png 700w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/ef8d3/screen-present.png 1050w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/fed13/screen-present.png 1400w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/5b79c/screen-present.png 2100w,\n/static/fbbaf443f03da85035ccb2a80b3965f1/b1413/screen-present.png 2472w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n  </span>\n  </a></p>\n<p>看图可知，MDE 里面每一行其实就是一个 &#x3C;p>，所以其实没什么神秘的东西，不过就是加上了行号，还有 Syntax Highlighting 而已（这个我们后面会说）。怎么把上面提到的 TextModel 编程 HTML DOM 元素了，自己写个遍历器遍历一遍就好了，在这里不推荐自己拼接 HTML 字符然后用 innerHTML 更新，这样一来效率低下，二来需要手动过滤字符，三来不方便我们后续的更新。</p>\n<p>遍历一遍 TextModel，然后用 document.createElement 好了，这里你可能需要一个方便的工具类</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/util/dom.ts\">/src/util/dom.ts</a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">elem</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">elemName <span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> className<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> _elm <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>elemName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">)</span>\n        _elm<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">,</span> className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> props <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> key <span class=\"token keyword\">in</span> props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            _elm<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> _elm<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>具体的实现大家可以参考下列几个文件，不过因为已经实现了 Syntax Highlighting，可能现在的版本已经很复杂了，初学的话看可能有点压力</p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/view/viewLine.ts\">/src/view/viewLine.ts</a></p>\n<p><a href=\"https://github.com/vincentdchan/MDE/blob/master/src/view/viewDocument.ts\">/src/view/viewDocument.ts</a></p>\n<p>到现在为止，你可能已经知道怎么把 TextModel 里面的内容展现出来了，但是做一个编辑器，仅仅这样还是不够的，下一张讲讲如何更新视图。</p>","frontmatter":{"date":"2017-01-03T10:26:00.000Z","path":null,"title":"从头打造一个 Markdown 编辑器（一）：数据结构和展现","permalink":"markdown-editor-1","headerImage":null,"tags":["markdown","editor"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"从头打造一个 Markdown 编辑器（一）：数据结构和展现"}}}