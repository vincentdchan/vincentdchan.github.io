{"componentChunkName":"component---src-templates-blog-template-js","path":"/2020/02/using-js-to-manipulate-xattr-on-macos","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>任何可以使用 JavaScript 来实现的应用都最终都会使用 JavaScript. --Atwood</p>\n</blockquote>\n<p>通过浏览器和 Node.js，JavaScript 可以说上天入地无所不能。现在许多客户端应用程序也使用 Electron 进行开发。但是 Node.js 本身在一些 native 操作上稍有欠缺，比如说 mac 下文件拓展属性。</p>\n<h1>什么是拓展属性</h1>\n<p>拓展属性是 mac 下文件系统提供的一种机制。除了基本的文件属性（修改时间、创建时间等），mac 还允许用户和程序自定义属性。这个属性是一个以 key-value 形式储存的键值对。key 是 UTF-8 字符串，value 则是任意形式的数据。</p>\n<p>Mac 下一些系统程序也依赖这个拓展属性。比如说我们去 Node.js 官网下载一个 pkg 安装包，然后打开，mac 会弹出这个框。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9861b50f81a6a48053283ea22289be12/dd104/quarantine.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.142857142857146%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACV0lEQVQoz62Sy2sTURTGB4ILiwu1goJKsu06K5sUujCkUIrrELJwJ0hX+RPaQteKtWCiZGNx0yK0izYvknSjTdBJm+bZycxk7LwykxQRGoc7x3Mv2gZdiODAb74zM+d895w7lwMA7n/CEUK4xcXFa9Vqde3o6Gj78PBwE3WrXq9vNRoNRrPZZIw/U8W8zVqttsPz/LNYLDYxGo045hqJRO52BcE2DAM0XYfT01PodDrQbrcZx8fHgAbQarUYuBigKcvTNA0EQVDn5+fvsA7p7WEo5NVUtfvxEw/vM4XvX1TdyWTSzu7urpPL5Zx0Ou1ks1mnVCo5xWLRyefzTqFQcMrl8ogu2Ov1moFA4N6F4czMjM80dDmZ2oDk88fEVA6gXKnC/n6JdYIFDEmSGGMxoVOhdtDw/oVhOBz2YZKsaTroSo2YmohjNoDnPwPuEyoPuMdQqVTg5OQEZFkGodvFkVVi2QNmGAwGLw3n5uZ8mCTbtg1964yYpuVKkuiKoujiPrmqql6g67qLXblDS3cHfZV8HZrQk6XOg+nAH4Ziv98H0zQcLCD4Iwh2RfA9LmDS0RhoiKqTSssiH+qWc9AaQluQ2qHZ6UtD/EM+RVGMwWAAlmUB7ZTGFBqPYyFnQxtepL/B6vY5rO6cQ7WpKLFHPzukl9frnUwmk08TicTK+vr6ErL8NzZSL5ffpdaWNt++WnnzOvFk8tbtG8xsYWGByhVkArmO3PxHaM1V6hGcDXNcPB7n/H4/l8lkPHjmPHj2PHt7e4xf8e86/p3W4Dn1TE1NcdFolPsBbXyMCLRzAAAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"quarantine\"\n        title=\"quarantine\"\n        src=\"/static/9861b50f81a6a48053283ea22289be12/8c557/quarantine.png\"\n        srcset=\"/static/9861b50f81a6a48053283ea22289be12/4edbd/quarantine.png 175w,\n/static/9861b50f81a6a48053283ea22289be12/13ae7/quarantine.png 350w,\n/static/9861b50f81a6a48053283ea22289be12/8c557/quarantine.png 700w,\n/static/9861b50f81a6a48053283ea22289be12/e996b/quarantine.png 1050w,\n/static/9861b50f81a6a48053283ea22289be12/dd104/quarantine.png 1064w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>你可能会好奇，这个对话框上信息很全呀，系统怎么知道我是用 Chrome 从 nodejs.org 下载的呢？实际上是因为 Chrome 在你下载的这个 pkg 文件上设置了一个叫 com.apple.quarantine 的属性。怎么查看这个属性呢，其实可以用命令行看到：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">xattr -l node-v13.9.0.pkg</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c19598bcd7f9ff4b895192278e3913a9/864a6/screenshot-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.285714285714285%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnklEQVQoz42Sy07CQBSGB1qgFyjSG8UOIHSncePCR2jiI5u4o8FGNz6Klx2WOf7npCHEYHDx5ZxOM1//OVMVday7Sei89Ufe1up2a8u26i6qUqoeDAa167q14zh1v9+Xniu/O+IZvICnTqezUJHrlmme0kWWUjAKyPM8goBs26Zer0eQCtxDRpZlETafYgeuVT7X5XK1pjhJd2EY7iHcI4lUCKT3fV/gZ3xoD/mhYq1phR9IeKN0rsvFfE5JkjTATCYTA7FJ09REUWR4DXIDsQCRQUqBe5a2wk8RrtfrElA6nTZaa5NlGUFGEFMQBAIfFXMVThzVtPULIKFGwsWCkEYSohIS0nA4JCSSeXLPYn4+KyyKogQUx3GDdCKEmGazmSTFOnFq/ij3Z4XL5bJcrVaccDfFsXmWnBYyqUjb8MfyPJeKTb/5boXvcsuY30OBGSZtEk53nJB7Pu54PCbc9F+/DMOXc6t817kPtX6Ntd5gQ4WZVbjVCvM6gP9Q4B4XU2HjMRuwBY/gCihLXWb+oCiG6P8FpFLxmxzjYa37AwgEx/w27RxNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot 1\"\n        title=\"screenshot 1\"\n        src=\"/static/c19598bcd7f9ff4b895192278e3913a9/8c557/screenshot-1.png\"\n        srcset=\"/static/c19598bcd7f9ff4b895192278e3913a9/4edbd/screenshot-1.png 175w,\n/static/c19598bcd7f9ff4b895192278e3913a9/13ae7/screenshot-1.png 350w,\n/static/c19598bcd7f9ff4b895192278e3913a9/8c557/screenshot-1.png 700w,\n/static/c19598bcd7f9ff4b895192278e3913a9/e996b/screenshot-1.png 1050w,\n/static/c19598bcd7f9ff4b895192278e3913a9/2cefc/screenshot-1.png 1400w,\n/static/c19598bcd7f9ff4b895192278e3913a9/864a6/screenshot-1.png 2276w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如果你使用命令 xattr 把属性去掉，系统则不会再弹框了：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">xattr -d com.apple.quarantine your_file</code></pre></div>\n<p>像 <code class=\"language-text\">com.apple.metadata:kMDItemWhereFroms</code> 这个属性就告诉了我们这个文件是从哪里来的。像上图中的文件是我从浏览器下载的，就储存了这个文件下载的 URL。</p>\n<p>比如你使用 AirDrop 传输文件，这个属性就会储存你的来源设备：</p>\n<p>像上图，我用 iPhone 传了一张图片，属性里面储存了我的 iPhone 的设备名字。属性显示这个文件是从 sharingd 来的，而 sharingd 就是 AirDrop 的后台进程。所以对于一些文件来说，读取这个拓展属性可以知道这个文件的来源。在一些操作中，这个信息还是挺有用的。</p>\n<p>而这个 kMDItemWhereFroms 属性的格式则是 mac 下比较常见的 plist 格式，下文会讲解如何读取这个格式。</p>\n<p>拓展属性它还可以为文件设置自定义图标，比如说你可以为普通文件和文件夹设置你喜欢的图标，这个图标的内容就储存在拓展属性里面：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75381309d74dd791282115402ea4fe74/6f464/custom-icon-screenshot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACRUlEQVQ4y62SXW/SYBTHy41LKN74AXxu9IYvYJZ4t+m1xI/jBzDxxsSLJV55KWrYgnPQFcXxMmEsMth4GS1QCgXpC2Db0TFoe3xayeKSgS7xn/7zPOfknF/OyVMi+3xj5dubZ+gV/QL1BAkxLIsSySTao2MoTe+iSPYIvQ7toL0vMZRMpVAmk0GJRAKl02mUwnE8Hnfiu7FY7Fa9XieIr1vb6+3q98lJs6Dtp/e1XO5A51stnet0dF4Q9DJT1wuVGs5xegvnWZbVeZ7XOc6NNUEQznA8CofDDxRFIYj3m1uBJi+A0O1DvnAMxZMySMMhMIeHUM1kQVJkUGQZRqMRDHFekiT3jptdq6oKg8EAgsHgGgAQxMcIFSjV6lBiGuZAG1sDzbCnAPbG2mP75epDGxcts+WcJhZFUb+Bnyg6UGGbgKFWVxrY0kgDY2ZCMbQJ+eA7cGTb9iI7UJjNZlY0Gp0Do3TgtNFygY121xaHKoyNCWjnBqiGAfOefwfuULHAUakKxUrNBco/dTAmU5hTLmHX6foJ8cplpgF4bYvviXanr2DgxZWpFkEXAp1HOa4y1mmDw0D5CvDGE25Hd5+wrQ7gdWd4XRPbGp9PnNezLNvG31KbTt10Op1FIpFL4FNO+AGCqEBPHoKinsGFacFN5AxK0/QjF/j2Q2g9lT1sfk6kmFy+yFaYBsu3BVaSRLbf77OiKC4zg13HdVX8Y6+6QI/Hc5sgiPvYftLn8/uwvV6vnyRJ9/yb53X3cD9J/Kk75ArxP/QL/JhK3VLtENMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"custom icon screenshot\"\n        title=\"custom icon screenshot\"\n        src=\"/static/75381309d74dd791282115402ea4fe74/8c557/custom-icon-screenshot.png\"\n        srcset=\"/static/75381309d74dd791282115402ea4fe74/4edbd/custom-icon-screenshot.png 175w,\n/static/75381309d74dd791282115402ea4fe74/13ae7/custom-icon-screenshot.png 350w,\n/static/75381309d74dd791282115402ea4fe74/8c557/custom-icon-screenshot.png 700w,\n/static/75381309d74dd791282115402ea4fe74/e996b/custom-icon-screenshot.png 1050w,\n/static/75381309d74dd791282115402ea4fe74/2cefc/custom-icon-screenshot.png 1400w,\n/static/75381309d74dd791282115402ea4fe74/6f464/custom-icon-screenshot.png 1464w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>更多关于拓展属性的用法大家可以自行去搜索资料了解，下文讲讲如何在 JS 里面操作拓展属性。</p>\n<h1>使用 JS 操作</h1>\n<p>由于 Node.js 环境下缺乏比较好用的操作 xattr 的库，所以这里推销一下我封装的 <a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a>，功能很全很强大。使用 N-API，支持同步异步操作、设置自定义 icon，解析 plist 等实用的功能。同时支持 TypeScript，提高开发效率。</p>\n<h1>安装</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">yarn add node-xattr</code></pre></div>\n<h1>获取 xattr</h1>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 同步版本</span>\n<span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> <span class=\"token function\">getXattrSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//获取 Buffer</span>\n<span class=\"token keyword\">const</span> string <span class=\"token operator\">=</span> <span class=\"token function\">getXattrSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取 string</span>\n\n<span class=\"token comment\">// 异步版本</span>\n<span class=\"token function\">getXattr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">buffer</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">getXattr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>设置 xattr</h1>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">setXattrSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">setXattr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>设置自定义图标</h1>\n<p><a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 提供了简单的 API 可以直接设置自定义图标，不需要去了解系统的储存格式。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> macUtils <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-xattr'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmacUtils<span class=\"token punctuation\">.</span><span class=\"token function\">setCustomIconSync</span><span class=\"token punctuation\">(</span>TestFile<span class=\"token punctuation\">,</span> iconPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmacUtils<span class=\"token punctuation\">.</span><span class=\"token function\">setCustomIcon</span><span class=\"token punctuation\">(</span>TestFile<span class=\"token punctuation\">,</span> iconPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>解析 plist</h1>\n<p>目前来说 <a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 提供了简单的两个函数，可以用于解析 kMDItemWhereFroms 这个字段。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> getXattrSync<span class=\"token punctuation\">,</span> macUtils <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-xattr'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> <span class=\"token function\">getXattrSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'com.apple.metadata:kMDItemWhereFroms'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//获取 Buffer</span>\n<span class=\"token keyword\">const</span> list <span class=\"token operator\">=</span> macUtils<span class=\"token punctuation\">.</span><span class=\"token function\">deserializeArrayOfString</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>总结</h1>\n<p><a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 这个库提供了操作 xattr 的能力，可以让你完成很多 Node.js 本身做不到的事情。有了这个库，你可以发挥你的想象力，在你的 Node 程序、 Electron 程序里面直接操作拓展属性，实现你的 macOS 原生化功能。</p>","frontmatter":{"date":"2020-02-22T21:00:00.000Z","path":"/2020/02/using-js-to-manipulate-xattr-on-macos","title":"使用 JS 操作 mac 下文件拓展属性","permalink":null,"headerImage":null,"tags":["electron","nodejs","frontend","javascript","C++"]}}},"pageContext":{"title":"使用 JS 操作 mac 下文件拓展属性"}},"staticQueryHashes":["3128451518","3159585216","3649515864"]}