{"componentChunkName":"component---src-templates-blog-template-js","path":"/2020/02/using-js-to-manipulate-xattr-on-macos","webpackCompilationHash":"19d960240cf064946cbc","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>任何可以使用 JavaScript 来实现的应用都最终都会使用 JavaScript. --Atwood</p>\n</blockquote>\n<p>通过浏览器和 Node.js，JavaScript 可以说上天入地无所不能。现在许多客户端应用程序也使用 Electron 进行开发。但是 Node.js 本身在一些 native 操作上稍有欠缺，比如说 mac 下文件拓展属性。</p>\n<h1>什么是拓展属性</h1>\n<p>拓展属性是 mac 下文件系统提供的一种机制。除了基本的文件属性（修改时间、创建时间等），mac 还允许用户和程序自定义属性。这个属性是一个以 key-value 形式储存的键值对。key 是 UTF-8 字符串，value 则是任意形式的数据。</p>\n<p>Mac 下一些系统程序也依赖这个拓展属性。比如说我们去 Node.js 官网下载一个 pkg 安装包，然后打开，mac 会弹出这个框。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9861b50f81a6a48053283ea22289be12/efc66/quarantine.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 61.09022556390977%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACMklEQVQoz62Sz2vaYBjHhUkZY7fRXrbIdo7nKeLVm5rCTh6H7B/wOrr7oCcdaHGHXXaqU8cOoqjTdfRSxd+dJTHzZ8wPf1BmRF8Sn71JJe0Kgw4W+PC875s8H755EhMAmP7XtdlsrhY+n+9+pVJ5XavVItVqNYjru2azadBqtXRu7/GzoW3PQSAQeGCY3W73HsMwEsAGlsslyPIC5vM5zGYzHUmSYDKZ6OvpdKrvtSrLMuBU0Ol0Zn6//7EhfG6zPeG4EX1OM5A5La85XkL5fA6l02mUy+VQKpVCmUwGFYtFVCgUUDabxffzqFwur1mWheFw2KEo6qkhJK1WQhIF9sPHYwgdvlSFwRmclWpwcvIN2u02DAYD6Pf7Ot1u16hYpmpJ8b7n9XqfGUKbzUbgJnY8FmDInKoTnoZm8wfgBNBoNADPCOr1OpRKJaBpWpd1OiyMOE5dLGRdSN0UOhwOotfrsculDNP5L1WSZjDYJuI47g8EQQBRxDOciDCVeHW5uMRv0O95PDeEdrtdEzLa0EVRQBgFf0UFJ1PwuSKKooJFOjzP48orF11ROWclxAwvge32f77Y91wLnU4nMRqNBPxPwmq1AoTQX1ljQEXw/jvA2wzA4VeA2sV4EnhFXQsJgngUj8cPkslkNBaLHd2FxCeN46MvnxPRRCL+hiStu7rM5XJpZQfzEKMd7v0ju9veHYrav0posVhM0Wj0XiQSMYdCoTsTDAbN4XDYrPWSJKm7fgMzrCU6kl6VJAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"quarantine\"\n        title=\"\"\n        src=\"/static/9861b50f81a6a48053283ea22289be12/84ad3/quarantine.png\"\n        srcset=\"/static/9861b50f81a6a48053283ea22289be12/687da/quarantine.png 175w,\n/static/9861b50f81a6a48053283ea22289be12/0ab4d/quarantine.png 350w,\n/static/9861b50f81a6a48053283ea22289be12/84ad3/quarantine.png 700w,\n/static/9861b50f81a6a48053283ea22289be12/ef8d3/quarantine.png 1050w,\n/static/9861b50f81a6a48053283ea22289be12/efc66/quarantine.png 1064w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n  </span>\n  </a></p>\n<p>你可能会好奇，这个对话框上信息很全呀，系统怎么知道我是用 Chrome 从 nodejs.org 下载的呢？实际上是因为 Chrome 在你下载的这个 pkg 文件上设置了一个叫 com.apple.quarantine 的属性。怎么查看这个属性呢，其实可以用命令行看到：</p>\n<pre><code>xattr -l node-v13.9.0.pkg\n</code></pre>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c19598bcd7f9ff4b895192278e3913a9/01b76/screenshot-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.305799648506145%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABl0lEQVQoz42T7W6CMBSGj/iBAlNBvkqNkDlMtpvYTcwlc7vN/ZZsd2T8J7R7T4NGF83240lb8Ty87Skk6G4QOrS2bHonos05tm1vPM/buK67GY1GZmQ6nc4F7f8/MJfkEIlERHUwF3o6mWrXczWKdb/fN0BqGAwGhl6vp1F8i1eaTseyuF/u4iTVQRDUSNAMh8PGcZwGgtMcSc0awgYvMvAcL6styzq0wjX5fiDzPN8nSaLjOG4gVb7vK6zVbDZTURQpyBTECskVRKrb7Z7gNbbanISQyLIsjVBKqYQQLOa0ejweGyDTKNZIcm2bCjRnCX1ZFMU+DEPNaZBKMyzCVo0Mx6Ank4kZr0gvhZDI1Wq151RpmioWM8ekPOf0i8WCn/8tRJpsuVzuIGbBAdTcHB4hq/HckGVZDSE3oEbhb45NeaEojuflQ6lTpOBUnIblEOi2UWa7x/O8cY5H3sgiCn0hPqM8/0LBFtegwtlVOLsKXTXwbwzPcVUqFJ6zbfkGz4A65NjD3uOTi/m/QMfNiOtyDr4R6v4Ap7W/bFht/MMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"screenshot 1\"\n        title=\"\"\n        src=\"/static/c19598bcd7f9ff4b895192278e3913a9/84ad3/screenshot-1.png\"\n        srcset=\"/static/c19598bcd7f9ff4b895192278e3913a9/687da/screenshot-1.png 175w,\n/static/c19598bcd7f9ff4b895192278e3913a9/0ab4d/screenshot-1.png 350w,\n/static/c19598bcd7f9ff4b895192278e3913a9/84ad3/screenshot-1.png 700w,\n/static/c19598bcd7f9ff4b895192278e3913a9/ef8d3/screenshot-1.png 1050w,\n/static/c19598bcd7f9ff4b895192278e3913a9/fed13/screenshot-1.png 1400w,\n/static/c19598bcd7f9ff4b895192278e3913a9/5b79c/screenshot-1.png 2100w,\n/static/c19598bcd7f9ff4b895192278e3913a9/01b76/screenshot-1.png 2276w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n  </span>\n  </a></p>\n<p>如果你使用命令 xattr 把属性去掉，系统则不会再弹框了：</p>\n<pre><code>xattr -d com.apple.quarantine your_file\n</code></pre>\n<p>像 <code>com.apple.metadata:kMDItemWhereFroms</code> 这个属性就告诉了我们这个文件是从哪里来的。像上图中的文件是我从浏览器下载的，就储存了这个文件下载的 URL。</p>\n<p>比如你使用 AirDrop 传输文件，这个属性就会储存你的来源设备：</p>\n<p>像上图，我用 iPhone 传了一张图片，属性里面储存了我的 iPhone 的设备名字。属性显示这个文件是从 sharingd 来的，而 sharingd 就是 AirDrop 的后台进程。所以对于一些文件来说，读取这个拓展属性可以知道这个文件的来源。在一些操作中，这个信息还是挺有用的。</p>\n<p>而这个 kMDItemWhereFroms 属性的格式则是 mac 下比较常见的 plist 格式，下文会讲解如何读取这个格式。</p>\n<p>拓展属性它还可以为文件设置自定义图标，比如说你可以为普通文件和文件夹设置你喜欢的图标，这个图标的内容就储存在拓展属性里面：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75381309d74dd791282115402ea4fe74/f99bc/custom-icon-screenshot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 68.30601092896174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACa0lEQVQ4y7WSz08TQRTHezExJhMunoyJHkw8KAo3qSmFhD/Co0c4VDxYuNlGDEcPSmJsirSNXkhMNPGoEgqVQkHQBigu3e52dmm73Z9tt2y77D6nWyIYaxoOvuSb9zKZ+cz3vRlX/N79c8/Gb6CxuXFk6YAW4osoHA6j189foDevXqKptx+R7/E0mguH0Fwkgubn51EoFEKxWAzNzs6imZkZFIlELkSjUZcT6S8LY7ndpLJJbTKJ+DJOp39gJpfDNMtihmXwVmYff9/JYJZhME3TmKIozBzXJLMY42I2m00GAoGLDnBxOfGkdtgAji9Aci0Fe9Q+KJoG7PYOHLAslMUyqIoCWqUCqqqCKIpQIbUsyyBJEpimCTzPC6Ojo1cc4NLKWoDmCrBHs02ldmgpesOqSLI1de269e7BQwsALNuynNxBR0RQr9e5iYmJNvDr2nowXxBgd582i5Jql7Ua6DUdPj2dhvT7D639QIBg2/ZvOWvt2joG8n6//wSISyJs/8ya7EHJLqtVqBsGyNUqVI3D04c76W8gaTlIsRykM5SZ4wq2SBw2zaMW5Q83naIjMLG6HmT4ImSyjMmVRLsgKtAggz7t7F/QjsDl1VQwxxUdhwRq84LUdngKciaHK6lvAV6QIZvnm6JatcgMrUaz2X5dcqCLnJt1XedOHiW1MVUxTGi12pqfVm/AWcMwDGFycvKqA/y8uPQoubGlk1kWSNsCneeFsigJmqYJ5CN3U5F8clkQhC2fz3fZAfb191+63dd/52bvLbdn0Dtw1+NxD3q97qGhoa7yer0Dw8PD7pGRkd6enp7zrv8RvwBV3Sf0GpYHOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"custom icon screenshot\"\n        title=\"\"\n        src=\"/static/75381309d74dd791282115402ea4fe74/84ad3/custom-icon-screenshot.png\"\n        srcset=\"/static/75381309d74dd791282115402ea4fe74/687da/custom-icon-screenshot.png 175w,\n/static/75381309d74dd791282115402ea4fe74/0ab4d/custom-icon-screenshot.png 350w,\n/static/75381309d74dd791282115402ea4fe74/84ad3/custom-icon-screenshot.png 700w,\n/static/75381309d74dd791282115402ea4fe74/ef8d3/custom-icon-screenshot.png 1050w,\n/static/75381309d74dd791282115402ea4fe74/fed13/custom-icon-screenshot.png 1400w,\n/static/75381309d74dd791282115402ea4fe74/f99bc/custom-icon-screenshot.png 1464w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n  </span>\n  </a></p>\n<p>更多关于拓展属性的用法大家可以自行去搜索资料了解，下文讲讲如何在 JS 里面操作拓展属性。</p>\n<h1>使用 JS 操作</h1>\n<p>由于 Node.js 环境下缺乏比较好用的操作 xattr 的库，所以这里推销一下我封装的 <a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a>，功能很全很强大。使用 N-API，支持同步异步操作、设置自定义 icon，解析 plist 等实用的功能。同时支持 TypeScript，提高开发效率。</p>\n<h1>安装</h1>\n<pre><code>yarn add node-xattr\n</code></pre>\n<h1>获取 xattr</h1>\n<pre><code class=\"language-js\">// 同步版本\nconst buffer = getXattrSync('./test.txt', 'key'); //获取 Buffer\nconst string = getXattrSync('./test.txt', 'key', 'utf8'); // 获取 string\n\n// 异步版本\ngetXattr('./test.txt', 'key').then(buffer => console.log(buffer)).catch(err => console.error(err));\ngetXattr('./test.txt', 'key', 'utf8').then(str => console.log(str)).catch(err => console.error(err));\n</code></pre>\n<h1>设置 xattr</h1>\n<pre><code class=\"language-js\">setXattrSync('./test.txt', 'key', 'value');\nsetXattr('./test.txt', 'key', 'value').catch(err => console.error(err));\n</code></pre>\n<h1>设置自定义图标</h1>\n<p><a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 提供了简单的 API 可以直接设置自定义图标，不需要去了解系统的储存格式。</p>\n<pre><code class=\"language-js\">const { macUtils } = require('node-xattr');\n\nmacUtils.setCustomIconSync(TestFile, iconPath);\nmacUtils.setCustomIcon(TestFile, iconPath).catch(err => console.log(err));\n</code></pre>\n<h1>解析 plist</h1>\n<p>目前来说 <a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 提供了简单的两个函数，可以用于解析 kMDItemWhereFroms 这个字段。</p>\n<pre><code class=\"language-js\">const { getXattrSync, macUtils } = require('node-xattr');\nconst buffer = getXattrSync('./test.txt', 'com.apple.metadata:kMDItemWhereFroms'); //获取 Buffer\nconst list = macUtils.deserializeArrayOfString(buffer);\nconsole.log(list);\n</code></pre>\n<h1>总结</h1>\n<p><a href=\"https://github.com/vincentdchan/node-xattr\">node-xattr</a> 这个库提供了操作 xattr 的能力，可以让你完成很多 Node.js 本身做不到的事情。有了这个库，你可以发挥你的想象力，在你的 Node 程序、 Electron 程序里面直接操作拓展属性，实现你的 macOS 原生化功能。</p>","frontmatter":{"date":"2020-02-22T21:00:00.000Z","path":"/2020/02/using-js-to-manipulate-xattr-on-macos","title":"使用 JS 操作 mac 下文件拓展属性","permalink":null,"headerImage":null,"tags":["electron","nodejs","frontend","javascript","C++"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"使用 JS 操作 mac 下文件拓展属性"}}}