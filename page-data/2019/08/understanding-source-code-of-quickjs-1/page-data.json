{"componentChunkName":"component---src-templates-blog-template-js","path":"/2019/08/understanding-source-code-of-quickjs-1","result":{"data":{"markdownRemark":{"html":"<h2>简介</h2>\n<p>Quick JS 是 Fabrice Bellard 今年发布的一款 JavaScript 引擎，具有以下特性：</p>\n<ul>\n<li>轻量而且易于嵌入：只需几个C文件，没有外部依赖，一个x86下的简单的“hello world”程序只要180 KiB。</li>\n<li>具有极低启动时间的快速解释器： 在一台单核的台式PC上，大约在100秒内运行ECMAScript 测试套件1 56000次。运行时实例的完整生命周期在不到300微秒的时间内完成。</li>\n<li>几乎完整实现ES2019支持，包括： 模块，异步生成器和和完整Annex B支持 (传统的Web兼容性)。</li>\n<li>通过100％的ECMAScript Test Suite测试。</li>\n<li>可以将Javascript源编译为没有外部依赖的可执行文件。</li>\n<li>使用引用计数（以减少内存使用并具有确定性行为）的垃圾收集与循环删除。</li>\n<li>数学扩展：BigInt, BigFloat, 运算符重载, bigint模式, math模式.</li>\n<li>在Javascript中实现的具有上下文着色和完成的命令行解释器。</li>\n<li>采用C包装库构建的内置标准库。</li>\n</ul>\n<p>本文主要记录我阅读 QuickJS 源码时记录的一些心得，主要用于学习用途。</p>\n<h2>编译</h2>\n<p>源码下载地址：<a href=\"https://bellard.org/quickjs/\">https://bellard.org/quickjs/</a></p>\n<h3>编译 qjs 引擎本身</h3>\n<p>qjs 本身用于直接执行 JavaScript 代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ make qjs</code></pre></div>\n<h3>编译 qjsc 编译器</h3>\n<p>qjsc 编译器可以把 JavaScript 代码编译成 QuickJS 虚拟机的字节码（可直接通过 QuickJs 虚拟机执行）。 也可以把 JavaScript 代码编译成一个 C 语言的 .c 文件，这个文件包含了字节码：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e55cbce2ab1591c58a3346e75b42ca95/c1328/qjs-bytecodes.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADSElEQVQ4y61TS4scVRSulb/AZeg4YaZ7ut7vurduPbqqq2t6+pWumdE4CYJkk4ULbRQMBKKJQQ0ihISIIC4CblIE8oeCtXHrRuyFdqqO51bPhERc2vBxHn3vV9/5TpXw6Xy6c3Uej4zUP9EMWki6WygmLXTTLVTVLGw/KRyEH+eFH2WFZtFCNrxCsxme8QoZz8sGOdJtNr/x0cdvCYvZySrLZ79pXgRdhQBeBt2kcEljsGNEICkWSLoHPdmEi10NdkUTRNWGnT0JLkoO9HUCPcmA3b62+ezzWxeE8eXTVZQtfzXcBLoafemwUW2StN5XSd1F7Mt23VOcuodxT7TqruzU+1h3Jazb3H2JOfRV78879+53hPH8yipI55XuDoBflqykUbxxI2leIxuskc4gn0HS/Rayyfs+79V9jYJFs/WjH590hMMFJ5xVmhPjWE7dVzwwtRgMPQbZ9kB2SBtF0wWuZA/RfRPNbt8Ew0vXP/z0CxJOFqtk+kHl5NehKxq1qFIkG4Bp+WC5BHT0yNS20BCWRfiDX0eDVoDuxOsHj3/uCBP0MDk4qkya8aehJ6hKYaDgIlQDgbWuIrFBgKtHD2FP3CrlkSs883D9xd2v+cjvr6LhojLQw57s1jKqSPwBJEEAg4BBTBikftDWEUZGfKAeBeJSCKgPMnrNiUXNW3/51TcdYbq8uhoeHlcWHUJP8WpcBl4g7SUfQckWPtkScMK2jwj/i3CMS2HJrFLtCPirIqoeeC6/4LdwnW3Oe+5ZnyDZ+ZlXhOo54fy9FY0nlWqFgOuvZVzCMGQ4IoMBw5ERKebDMGjrDCPPee9gEOJHQJpdXMorhfns3ZUbHFSyEaCxrcLGc2jjOKQFjtagojaeA9U1tk0aHL+R9X8pnBXXPkEPX9joIRL+hR5uIt/foDJEsEnDYIML2aA67LNNinn8Wq4a5G9U2Iga+ePOvW87QnZ4dJMl09/5yFvpBHwWAyEhOA565zH0Dn0jAbiYb2OA/21z1WTAXzX8NOHW7bvvCMvj00k2vvwwnx49T/P508XxtXJ55cNyND0pSTgqaZSXJBq1dTpeloN80SIcTsoom5X59LicFafP8mnx5P53378t/J8/ABD+ATXN1E9EeMAvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"QuickJS 把 JavaScript 编译成字节码\"\n        title=\"QuickJS 把 JavaScript 编译成字节码\"\n        src=\"/static/e55cbce2ab1591c58a3346e75b42ca95/8c557/qjs-bytecodes.png\"\n        srcset=\"/static/e55cbce2ab1591c58a3346e75b42ca95/4edbd/qjs-bytecodes.png 175w,\n/static/e55cbce2ab1591c58a3346e75b42ca95/13ae7/qjs-bytecodes.png 350w,\n/static/e55cbce2ab1591c58a3346e75b42ca95/8c557/qjs-bytecodes.png 700w,\n/static/e55cbce2ab1591c58a3346e75b42ca95/c1328/qjs-bytecodes.png 866w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>但是编译 qjsc 编译器首先需要编译 libquickjs 库：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ make libquickjs.a\n$ make qjsc</code></pre></div>\n<p>使用 qjsc 编译器把 <code class=\"language-text\">my_test.js</code> 文件编译成 <code class=\"language-text\">my_test.c</code> 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ./qjsc -e -o my_test.c my_test.js</code></pre></div>\n<h3>使用 XCode 进行 Debug</h3>\n<p>如果你想很清楚地了解整个虚拟机的执行过程，可能你需要 XCode 来进行单步调试：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5d570bd15780631e08356203da540ad/c1bea/xcode-debug.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.142857142857146%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACWUlEQVQoz4VSS47UMBDtu7DjFFyAM7QXA3voBRJ3GiIhIc2GCzQSCAbS6SST7rTzcez8k07SHcdFOTPMwMwCS6WyVfbze69q4ZjfX9qOebXZWJe24xhbxzXsrWk4zta4ubkxdv7OoJQa+/1+Ds/zDMuyDNM0je3WNr6s1x9+XP+6NG3vk2k5LxbXpv3e9ii4Bw5+mEDTtpBnHIRIoG2PeG6g67p/4ng8Yq2d90IIONAAgjCCMAxfL5wdfeMFHGhSDLHIR6Wmsa6bcRzlCAD/DQQf0zQ9ZVkGmJeLz9/C1dXah49rJr+6uQKYoG1a/RsURQFd38MwDND3A5xOZ1BK3YdeTdMozrnUTDGTRRiz1U9zg5JjmZU13ptmSfRAoapqUJN6AjKvR4DI7haQRsnKDxnwvJKiKFXTd0CjCIqmRk0KTpOEAdU/jm4cIO0yEGWqkN0DQ5YWqyQrAbPMkaGUEjjjkHAOw+kEcprgL14PBEGbo2aGcRzLJEl0gxBQ5CsEAwSVkUhVzBP9E+gLaZZjxzPI81wbDgVmBADdgKqqZm/LspwZ3kv+A8izejyIWFn7rSpROjLVJBQ+UtgchXOnXNed9ziLSgPp+hMPWZq/vQWszj6PJAJKFjGJciU+kDhrEgdcRlEkkdl8RkANIM/ns2ybRnIuzneAS83wHUcPRV6Dzxl224UauysnOXvV49hoC/QIaZn6jOBa6uxxiXd1/a4pF3psnrOEvwoZX1q7gIRxSFKREvSN1HVNGGMkCALi+z5BIKJlIRtSFgURWUk8inV6WNIguMD6s9/w2WqamXYAHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"使用 XCode 进行 Debug\"\n        title=\"使用 XCode 进行 Debug\"\n        src=\"/static/d5d570bd15780631e08356203da540ad/8c557/xcode-debug.png\"\n        srcset=\"/static/d5d570bd15780631e08356203da540ad/4edbd/xcode-debug.png 175w,\n/static/d5d570bd15780631e08356203da540ad/13ae7/xcode-debug.png 350w,\n/static/d5d570bd15780631e08356203da540ad/8c557/xcode-debug.png 700w,\n/static/d5d570bd15780631e08356203da540ad/e996b/xcode-debug.png 1050w,\n/static/d5d570bd15780631e08356203da540ad/c1bea/xcode-debug.png 1388w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>为了能在 XCode 下进行调试，你可能需要先在 Makefile 里面把优化给去掉。\n打开 Makefile， 在里面找到这一句：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CFLAGS_OPT=$(CFLAGS) -O2</code></pre></div>\n<p>改成：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CFLAGS_OPT=$(CFLAGS) -O0</code></pre></div>\n<p>接下来就好办了，我们照着 <a href=\"https://blog.csdn.net/u011577874/article/details/73000207\">这篇教程</a> 走就可以在\nXCode 里面 debug 了。</p>\n<h2>OPCode</h2>\n<p>QuickJs 的虚拟机使用栈式虚拟机。对于什么式栈虚拟机推荐阅读 <a href=\"https://www.iteye.com/blog/rednaxelafx-492667\">这篇文章</a> 了解。</p>\n<p>QuickJS 的 OPCode 十分简洁和紧凑。所有 OP 码的定义都放在 <code class=\"language-text\">quickjs-opcode.h</code> 文件里面：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/e996b/quickjs-opcode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADNUlEQVQ4y6VTy24TSRRtRgLxDbNBiMT9fr/L3X60H+3YJsaxAoIEZiSUsSbECURIgEBs+Av4B1jRtkDzIaPe8wOIXkC7L7c6IQY2LFgc1a2qrtPn1LnF7PZHG8Nu+6VSJe8FxX0r634i6V7CKU5S0UiimCSRjZM1EfcEFdcFLVlT3ISVrYSTzLe8bC1wfD3evvUns7V5fb/dGaSiE4JihoVNmmB5deBVDy5rAYiqA0gCFdGAK4KB6w6ssTJcUghUZBs4yQBWMmFd0LMbO39zzHBye1bvjlPJrINkhUuHtAo36BSyGRRrol1URBNhFeu8UVxBsBLWAtZ0D2u6j3MktrO7e/sS0x/dPAga/VQ2CLCymztaq9DNVsFrpODKAyuw383Z1fpyXTDRhfdpevRYZIbj3Vmjv5tqZAicbC9VJQRJq6EdF/AQWv0lCkoom2F2//ELJNxCwt52qrpt4BR3aah10K0OcHpAbeBPXIRzBlZZzfmTEZXbIOrV7N+Hz0Vmc4KE3VGKgZSExIjBNNrAGxiI5iMISDoB2aiWNW+E5VzCPcWs4jop6By/ze5OD0VmtH1n1ozHqWLVgFe8JY/K6Iei6oKAKcq6R+8Hk3RKtTwqpIp+toxdke3tPxCZa9t/zaLeJFXtOipEQtU/U4B9iUBrCOzLkogSfyPEkGhNgwEBFU7vPzmxTBWqpUJ/KXrd8pDpNcANu6CZPpiWB7YVgaSSU6IV8Rmh6mf/HD6iKe/M6p1rpWUOCSXSA8UKwQk6QKIBBkTAsn1wnTYoeB0sDUNxv8cpoZdNj5Awvnp95gRxSi+cWpb8mMoHFe/RJhEqPCGkL4iGtFJo/6BQ1INseowpD8a37gXN4f8ypoqEn0U/zlFFbvvNHF9NjoS5bftYRznea45tkqOqHDvi2/iFkuL5j4fHz0rLx1G89YFaxpcCarUPEraG7jTAq8WgWQGYdhUsP6LNS38KNDiejqeooFIa4GzvQGZGk5tXW73Rq3qr/18UbyYboxvz7mCyCBq9RXewtag24oUftuek1pk3u5vzentYotbqz2vRRjni+XdRPHpz/OjpJQYA/kCcR1z8TVxAnPsKaOUJZNWUDOQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"QuickJS 的 OP 码\"\n        title=\"QuickJS 的 OP 码\"\n        src=\"/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/8c557/quickjs-opcode.png\"\n        srcset=\"/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/4edbd/quickjs-opcode.png 175w,\n/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/13ae7/quickjs-opcode.png 350w,\n/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/8c557/quickjs-opcode.png 700w,\n/static/75f622fd7f08e5fa7bc3eaa3a6a2913f/e996b/quickjs-opcode.png 1050w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>从上图可以知道 OPCode 定义分为这几个部分：</p>\n<ul>\n<li>id: OPCode 的名字</li>\n<li>size: OPCode 的字节大小。比如说 <code class=\"language-text\">push_i32</code> 指令的 size 是 5. 那么第一个字节用来存 OPCode 本身，\n后面四个字节用来存 32 为的整型，也就是四个字节。</li>\n<li>n_pop: 从栈上面弹出的元素的数量。和下面的 n_push 一起用户统计函数需要分配的栈的大小。</li>\n<li>n_push: 从栈上面插入元素的数量。</li>\n<li>f: 字节码的格式。</li>\n</ul>\n<h2>Runtime</h2>\n<p>在虚拟机内部，运算的最基本单位是 JSValue，一个 JSValue 可以用以下 Tag 来标示：</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">enum</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* all tags with a reference count are negative */</span>\n    JS_TAG_FIRST       <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* first negative tag */</span>\n    JS_TAG_BIG_INT     <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n    JS_TAG_BIG_FLOAT   <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n    JS_TAG_SYMBOL      <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    JS_TAG_STRING      <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    JS_TAG_SHAPE       <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* used internally during GC */</span>\n    JS_TAG_ASYNC_FUNCTION <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* used internally during GC */</span>\n    JS_TAG_VAR_REF     <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* used internally during GC */</span>\n    JS_TAG_MODULE      <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* used internally */</span>\n    JS_TAG_FUNCTION_BYTECODE <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* used internally */</span>\n    JS_TAG_OBJECT      <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n\n    JS_TAG_INT         <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    JS_TAG_BOOL        <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    JS_TAG_NULL        <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    JS_TAG_UNDEFINED   <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    JS_TAG_UNINITIALIZED <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    JS_TAG_CATCH_OFFSET <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    JS_TAG_EXCEPTION   <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n    JS_TAG_FLOAT64     <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/* any larger tag is FLOAT64 if JS_NAN_BOXING */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>那么一个 JSValue 的表示是这样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">union</span> JSValueUnion <span class=\"token punctuation\">{</span>\n    int32_t int32<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">double</span> float64<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> JSValueUnion<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">JSValue</span> <span class=\"token punctuation\">{</span>\n    JSValueUnion u<span class=\"token punctuation\">;</span>\n    int64_t tag<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> JSValue<span class=\"token punctuation\">;</span></code></pre></div>\n<p>从这个结构体可以看出一个 JSValue 占用 16 字节的内存。tag 用来表示这个 Value 的类型。而 <code class=\"language-text\">JSValueUnion</code> 则是\n用来储存真正的值。这个值可以是 int/float 或者一个指针指向一个真正的对象。</p>\n<p>真正的对象在 QuickJS 里面则是使用引用计数来进行内存管理，所以都有一个引用计数器：</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">ypedef <span class=\"token keyword\">struct</span> <span class=\"token class-name\">JSRefCountHeader</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> ref_count<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> JSRefCountHeader<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>命令执行</h2>\n<p>知道了上述背景之后，我们就可以看看 QuickJS 虚拟机具体的执行过程了。需要知道的是，一个栈虚拟机，需要两个很重要的\n指针，分别是 pc 和 sp。</p>\n<p>pc 指的是程序计数器。指向正在读取的 OPCode，读取之后 pc 会 ++，指向下一个字节。</p>\n<p>sp 是栈指针。指向栈机器栈顶的下一个元素，用来进行栈相关的操作。</p>\n<h3>入栈</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a01f65ed89f2ad910820f02f6125e98/e996b/qjs-add.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADdElEQVQ4y6VTy47bVBg2SEU8A5tWZOKx4+PrceL7LY6dycWZmaaawAwIDWVKNW2Kilj1BbotW5B4BBCLOhEVT8EKec8LILKAxD//cTrctiw+HV/O+fxdfnPnR8VokqVfqZ77SpB7LxXqlkSzS57QBrLhlJLWK6VuVBLqlYJMEWbJd/SyTcxSUMyXh8RYHxL67Xzx4TtcMZ5fp9m40uwQeNmqe24fVOpBS9ShJVGQNAvaggJ3jBgE3QFRpiAqXWjxMtwhPRBVC5AQDkRts/jgUuBGJ+fLKDutdKsPbcXZWf6g1sygbncMBK0PJVxFvX6XWHVbMvEenxGzPsBnLXZPumwvkpqbB1fXhBvNFo/9flFpPVSg2NuO5tRoveYJQnVr3srrg46OBFrzgRvwSMbvr3cHgg6KGf/25TevJG58/N7S708r1QyB2v2d1o1AkG0gQQH29BLS/AyC6B50jQhkxQKedFHNv4AODFCtwebF9z9J3GhyvEzG51U3uwRZd3YyDQEtgkgj8EbnMPVzyMMZGEbAbO1JJBP412CEqBQk3dtcP3vOFC6WcX63ou4QOqqzkzQP2AYBCczkBFJnAKEZgITht/cE/yTbK8T9Cg03nz19xgjfx1KOK8OKAdXtZCTiMWTRjMEeXcDMH0Jup6AZ3l+E/7XMyDuqtbl6+ETipqcXy/RoXpmoBGXviO43hAJatjC/oZdBgoUpmg1MyY269t9ro1BUrM0nny4xQ1ZKgqVgGYxQ0ty9ZSSmwRTSXgI+glDMUME5VGycxR5ICJE0a91BpZJqb+4/QMKjYrF0onGFGWD14Y4wy8waHlCsDFy/ANUIodPrg4AxSIYPqmqDiY0T3NNVndpUHSC6u7m8eiRxw+nZ0vKHFbMq0wAJ0TL+IQIqNbwRxHYGdjcGFVUKSMwcsHe8HuBUuOzDdevG8usMHyXDuz9TDB4b/h0PbNFyA1SwNWiCw+5u26q3PdS8rajaCGcraP5W1pwt2v+DDTiW8mtTSj6593k4mP2iWwngQWCWO8wCZqY4QzCDCeioWkOw90jWrGyYW/iHNEVhhqgQPvr4ocwVp2dFPJh8HWfTH6PBpMS5XBXzi3V6dLJ2gsHa9ZO1GwxW2eh0FefFKkzHqwRXL8ob4NlVPpn/kA5n3z15+sVtDgDeRNxCvP0/8RbijT8BobsMGyFREHgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qjs add\"\n        title=\"qjs add\"\n        src=\"/static/5a01f65ed89f2ad910820f02f6125e98/8c557/qjs-add.png\"\n        srcset=\"/static/5a01f65ed89f2ad910820f02f6125e98/4edbd/qjs-add.png 175w,\n/static/5a01f65ed89f2ad910820f02f6125e98/13ae7/qjs-add.png 350w,\n/static/5a01f65ed89f2ad910820f02f6125e98/8c557/qjs-add.png 700w,\n/static/5a01f65ed89f2ad910820f02f6125e98/e996b/qjs-add.png 1050w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>入栈操作就是把读入的值变成一个 JSInt32，然后赋值到 sp 指针指向的内存，然后 <code class=\"language-text\">sp++</code>。就完成了一个入栈操作。\n我们可以看到 QuickJS 的字节码实际是十分冗余的，具体为什么这么设计我不太清楚。估计是 0-7 之间的数可以用一个\n字节搞定，节省空间，但是我个人感觉也太省了，对实际运行应该帮助不大。</p>\n<p><code class=\"language-text\">OP_push_i8</code> 是一个两字节的 OP 码，第二个字节就是一个 8 位的整数，同理 <code class=\"language-text\">OP_push_i16</code> 就是一个三个字节\n的指令，入栈一个 16 位的整数。</p>\n<h3>加法</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26fc04630a6d21d4f24798f129c58c7c/68638/qjs-add-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.857142857142854%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACx0lEQVQ4y2VT227TQBDNK38BbWKv7fXa3l3bcRw7l6alaXmoQAUhVCoeWkgv9AoSvPAHSKgS/8GPIF6x1E/gloaHWNTD7KaquDwczezOzNkzM3Yt7w8+ERaeEyqKeSsomGwXnkyLOfSJKwvDDQtT5AX144JQXtyiYWF4zcJmsjCxpm75nzHv3KT8Y39p5Wat3RsC8WJwvAjqFgcatBAJzJEACJVQtwXMey2wXAmmw+GmE0KDxbMzFVAnvrYKq6trdi1qL31nMr/0wnxqOLJ0ZKcMw15puVE5b/GyYYvSsGd25otrX58dOa2ToKK8/fXozXtSS/prExb2wPFblxis7CCtRJhVQjQr34srx40qdW8iDBqiH1Ym/QuXDZuDG3bHJ2cfSC1dXEfCBU2IQWg4EpgbQzvuQhj3gPgpmF6ire1G4LAI25OASjFXAD6mhIDtJ+P1jW1Sa3WGE1dkM0IMECwiNIJAZhClXaBhF+xoEex4ABzzWJACER0weQ4ub6tHUKHAuafjR5sjUmv370ywf7C8plaoCA1UYLtN4EgiWgPwsNhmzVkMl2JiBwpEAVvWCr3m+N6DxzNCJvJrhSaNNCIkCQSqS5bBSW4DjXpA/QSoIsYtG7oTJP+XMO2tTlyeqRlct6yU+vipuKo92QNLzTheBNZaBpaugNMaQhAvgIcP/Ecok8EFDdozwqvNWSyuOM/Rl1XD4pWhoLasNq5y0BK1cYz/QfhDEyb58CdFhRZuUg3XuFIpZBeYXNCtKqU2jkHH1XY1pM5VqFtC1Vzcvb+hWl75FkSdXyLpT4MoL/EvKZlIS4oftuunpRdmJY87JeOpvnd5q6QIx29q2F48dXl6iTlf1h9umrXt0X4y2jvMj1+8zo5OX2XPdg+yvYOTbGu0lz3Z2s62nu5kO/tH2e7zY32voHys0dD5h6f5wfHL5O27sxu/AVfxj7OKsf4YAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qjs add 2\"\n        title=\"qjs add 2\"\n        src=\"/static/26fc04630a6d21d4f24798f129c58c7c/8c557/qjs-add-2.png\"\n        srcset=\"/static/26fc04630a6d21d4f24798f129c58c7c/4edbd/qjs-add-2.png 175w,\n/static/26fc04630a6d21d4f24798f129c58c7c/13ae7/qjs-add-2.png 350w,\n/static/26fc04630a6d21d4f24798f129c58c7c/8c557/qjs-add-2.png 700w,\n/static/26fc04630a6d21d4f24798f129c58c7c/e996b/qjs-add-2.png 1050w,\n/static/26fc04630a6d21d4f24798f129c58c7c/2cefc/qjs-add-2.png 1400w,\n/static/26fc04630a6d21d4f24798f129c58c7c/68638/qjs-add-2.png 1510w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>栈虚拟机上的加法就是从栈弹出两个元素，相加，然后入栈。这里首先从栈顶取出 op1 和 op2。然后判断是不是 int。\n这里的 int 类型是 32 位的。所以它先把他们切到 64 位进行相加。加完再切回 32 位的 int，看看数据是不是一样。\n若不一样，则说明加法产生了溢出，这个时候就丢到 add_slow 进行处理。</p>\n<p>若两个 op 都是 float64 则进行浮点数的加法。</p>\n<h3>If 分支跳转</h3>\n<p>If 分支跳转是程序里面很重要的一步，实现了分支跳转，for 和 if 语句都可以实现了。\nQuickJs 有 goto 指令，比较简单，这里就不说了，这里介绍一下 <code class=\"language-text\">OP_if_true</code>：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/83e893320956c5ea56965e06303824f9/68638/qjs-if-true.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.857142857142854%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACqUlEQVQ4y31SzW7TQBD2lbegbRL/rnft9b+9SRNKUdoeKhBFCFG4AAlJ27RNkeDCGyChSjwHT4K4YqmPwF8aDrGIh7HdUoIQh087O7Pz7XwzI4nO2scVwzlTiZMqiBWFpYYdpbYn0prOU416qWq6ac1KUrWwDZ4uqVZat+JUJbzI+YQ4kw37Q2d947oUt7tQIx7ozAeFcFiWKWh2AswRsKJxkA0H6poNy2YIiumCYtiwpFhQYxHaVVwuTw6bm9ua5Ce3vulWPDe5mBESZSoNM91ZzRq6g+BZXavQ0OwrW1+4z2qKlRt28uXw9TtFCtvbU+Z3wLSTuWp4uenfyINgLedWlKvEyxuGm8v/x7xQQNzVyfHpe0WKb+5MidMBjYVzrAoKaKYHrhOBSYPyLl/4/4WCsMxh4WRn95kiRa3u1LBi0Gg4xyDI2E9CfHDQZ1o+JnglGuhXjAIuaHhqpLIrQg7IMXnwuK9ISWdrivqvCBEqCcDDodh+E9SoC1q0AbbXAUrD8jOOlXO0ddOHxmWFpj+5vfOwIiRcYMnRvJoYEqJkRmNQmACZt0HFDykL8CMP6ph8iQXJNJjcubeLPWxvTXHKoNLgd4WGGQBjIcrCNSFFG/xS3oXEv7FI6ERr54aV4B4WFVaTK6ZrsjinPMmpm+Sq087xTU5YmGP1ORIsTPmC8HtJGLa6P4oeqlhVvVxklEwjIFYLCPZNd1rQwKVuYAuKN0Vy8e7PSddUjkq886qH7Y2vzG3+5EF7ZnnNzLDjjMXrGUrNZFxgnfqZyeOMWGFGMEbsqITOghIa9Wfon9t+6/Pd+49k6Wl/L+wPR82jk1ficPxS9Ab7YvB8TzztD8WT3lD0hiMxHJ2I4cFY7I3GeB6Lwf6RwJwSvcEBxsfNg6MX4Zu3p9d+ASBJjh78hyO1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qjs if true\"\n        title=\"qjs if true\"\n        src=\"/static/83e893320956c5ea56965e06303824f9/8c557/qjs-if-true.png\"\n        srcset=\"/static/83e893320956c5ea56965e06303824f9/4edbd/qjs-if-true.png 175w,\n/static/83e893320956c5ea56965e06303824f9/13ae7/qjs-if-true.png 350w,\n/static/83e893320956c5ea56965e06303824f9/8c557/qjs-if-true.png 700w,\n/static/83e893320956c5ea56965e06303824f9/e996b/qjs-if-true.png 1050w,\n/static/83e893320956c5ea56965e06303824f9/2cefc/qjs-if-true.png 1400w,\n/static/83e893320956c5ea56965e06303824f9/68638/qjs-if-true.png 1510w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If 分支跳转主要是看栈顶元素是不是为 true。若为 true，则把 pc 加等于相应的 offset。\n这个 offset 在 QuickJS 里面是 32 位的，这意味着 <code class=\"language-text\">OP_if_true</code> 是一个 5 个字节的\nOPCode。这个 offset 在编译的过程中就可以被算出来。</p>\n<p>图中有一个 tag 是否小于等于 <code class=\"language-text\">JS_TAG_UNDEFINED</code> 的判断。这个判断根据上面的 tag 的定义。\n我们知道只有这几个类型是不符合这个判断的：</p>\n<ul>\n<li>JS_TAG_UNINITIALIZED = 4</li>\n<li>JS_TAG_CATCH_OFFSET = 5</li>\n<li>JS_TAG_EXCEPTION   = 6</li>\n<li>JS_TAG_FLOAT64     = 7</li>\n</ul>\n<p>以上几个类型需要用 <code class=\"language-text\">JS_ToBoolFree</code>，进行判断，其他类型则可以从 JSValue 读出真正的 bool 值。</p>\n<h2>总结</h2>\n<p>QuickJS 源码实现非常简单易懂，是一个非常适合学习的 JS 引擎。有一点谈不上好坏的就是\n像 Bellard 这样的 hacker 出来的代码非常的骚气。比如说通篇的 goto，不过幸好不是很难懂，\n有些逻辑确实 goto 写起来比较爽这一点，可以理解。另一方面不太好的就是大部分代码都写尽了一个 .c 文件\n里面了，读函数调用跳来跳去比较麻烦。</p>\n<p>总的来说是比较适合阅读的源码了。</p>\n<h2>相关阅读</h2>\n<ul>\n<li><a href=\"/2020/12/understanding-source-code-of-quickjs-2\">QuickJS 源码解读（二）：基础设施和标准库</a></li>\n<li>QuickJS 官方文档：<a href=\"https://bellard.org/quickjs/quickjs.pdf\">https://bellard.org/quickjs/quickjs.pdf</a></li>\n<li>栈式虚拟机：<a href=\"https://www.iteye.com/blog/rednaxelafx-492667\">https://www.iteye.com/blog/rednaxelafx-492667</a></li>\n<li>X86 架构：<a href=\"https://blog.csdn.net/ajigegege/article/details/17055779\">https://blog.csdn.net/ajigegege/article/details/17055779</a></li>\n<li>使用 Xcode 进行 Debug：<a href=\"https://blog.csdn.net/u011577874/article/details/73000207\">https://blog.csdn.net/u011577874/article/details/73000207</a></li>\n</ul>","excerpt":"简介 Quick JS 是 Fabrice Bellard 今年发布的一款 JavaScript 引擎，具有以下特性： 轻量而且易于嵌入：只需几个C文件，没有外部依赖，一个x86下的简单的“hello world”程序只要180 KiB。 具有极低启动时间的快速解释器： 在一台单核的台式PC上，大约在100秒内运行E…","frontmatter":{"date":"2019-08-26T23:55:00.000Z","path":"/2019/08/understanding-source-code-of-quickjs-1","title":"QuickJS 源码解读（一）：虚拟机的实现","permalink":null,"headerImage":null,"tags":["compiler","QuickJS","javascript","C","编译器","虚拟机"]}}},"pageContext":{"title":"QuickJS 源码解读（一）：虚拟机的实现"}},"staticQueryHashes":["3128451518","3159585216","3649515864"]}