{"componentChunkName":"component---src-templates-blog-template-js","path":"/2019/02/parse-javascript-with-ocaml","webpackCompilationHash":"f81d09daa791dac990dd","result":{"data":{"markdownRemark":{"html":"<h1>èµ·å› </h1>\n<p>æœ€è¿‘åœ¨å†™ä¸€ä¸ªå…³äº JavaScript çš„é™æ€åˆ†æå™¨ï¼Œä½œä¸ºæˆ‘çš„æ¯•ä¸šè®¾è®¡ã€‚æˆ‘å†™é™æ€åˆ†æä¸»è¦æ˜¯ä¸ºäº† ES6 å±‚é¢çš„è¯­æ³•åšæ›´å¥½çš„ DCE(Dead Code Elimination)ã€‚æˆ‘é€‰æ‹© OCaml æ¥å®ç°è¿™ä¸ªé™æ€åˆ†æå·¥å…·ï¼Œç”¨ flow æ¥ parse JavaScriptã€‚</p>\n<h1>ä¸ºä»€ä¹ˆé€‰æ‹© OCaml</h1>\n<p>åœ¨å’Œå¯¼å¸ˆè®¨è®ºé¢˜ç›®çš„æ—¶å€™ï¼Œæˆ‘è·Ÿå¯¼å¸ˆè¯´è¿™ä¸ªé¡¹ç›®ç”¨ Java æ¥å†™ï¼Œä¸»è¦æ˜¯ Java æ¯”è¾ƒå®¹æ˜“è¯´æœè€å¸ˆã€‚å®é™…ä¸Šå¼€å§‹å†™çš„æ—¶å€™å°±å¡äº†å¾ˆå¤šç§è´§ï¼Œæˆ‘çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬å…¶å®ç”¨çš„æ˜¯ Scalaï¼ŒåŸå› æ˜¯ï¼š</p>\n<ul>\n<li>Scala é‡Œé¢çš„å¾ˆå¤šè¯­è¨€ç‰¹æ€§éå¸¸æœ‰ FP é£æ ¼ï¼Œä¹Ÿå¾ˆé€‚åˆç”¨æ¥å†™ç¼–è¯‘å™¨å’Œé™æ€åˆ†æå·¥å…·ã€‚</li>\n<li>è¿è¡Œåœ¨ JVM ä¸Šé¢æ›´å®¹æ˜“åšå¤šçº¿ç¨‹ï¼Œå¯ä»¥ä½¿é™æ€åˆ†æè¿‡ç¨‹æœ‰è¾ƒå¤§çš„æå‡ã€‚</li>\n<li>å¦‚æœæœ‰éœ€è¦ï¼ŒScala å¯ä»¥ç¼–è¯‘æˆ JSã€‚JVM ä¸Šé¢ä¹Ÿæœ‰å¾ˆå¤šå¯ä»¥å’Œ JS è”åŠ¨çš„æ–¹æ¡ˆï¼Œæ–¹ä¾¿å’Œå…¶ä»– JS library è”åŠ¨ã€‚</li>\n</ul>\n<p>ä½†æ˜¯å¼€å§‹ä½¿ç”¨ Scala çš„æ—¶å€™å´å‘ç°äº†è®¸å¤šé—®é¢˜ï¼š</p>\n<ul>\n<li>æˆ‘ä½¿ç”¨çš„ Parser å’Œ AST ç»“æ„éƒ½æ˜¯ Java å†™çš„ï¼ˆä½¿ç”¨äº† Graal.js çš„ Parserï¼‰ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ Scala çš„ case class é£æ ¼ï¼Œè¿™æ„å‘³ç€æˆ‘è¦åœ¨ Scala é‡Œé¢å†™ Java Style çš„ä»£ç ï¼Œæˆ‘è¡¨ç¤ºå¾ˆæ‹’ç»ã€‚æˆ‘å½“ç„¶å¯ä»¥ç”¨ implicit è¯­æ³•å†™ä¸€å±‚è½¬æ¢å±‚ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™æ ·å¾ˆè›‹ç–¼ï¼Œæ‰€ä»¥æ”¾å¼ƒã€‚</li>\n<li>æˆ‘è¦è¿›è¡Œçš„é™æ€åˆ†ææ˜¯åŸºäºå›¾ï¼ˆGraphï¼‰çš„ï¼Œä¼¼ä¹æ²¡åŠæ³•è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå³ä½¿å¯ä»¥ï¼Œä¹Ÿä¼šæœ‰è¶…çº§å¤š overheadï¼Œè¿˜ä¸å¦‚ä½¿ç”¨å•çº¿ç¨‹ã€‚</li>\n<li>å·¨æ…¢çš„ç¼–è¯‘é€Ÿåº¦å’Œå¯åŠ¨æ—¶é—´ã€‚ç¼–è¯‘é€Ÿåº¦ä¸è¯´äº†ã€‚è¿è¡Œé€Ÿåº¦ Scala åº”è¯¥æ˜¯å¾ˆå¿«çš„ï¼Œä½†æ˜¯å¯åŠ¨ï¼ˆé¢„çƒ­ï¼‰å´å¾ˆæ…¢ã€‚</li>\n</ul>\n<p>ç§ç§è›‹ç–¼çš„æƒ…å†µè®©æˆ‘é‡æ–°å®¡è§†ç”¨ Scala æ˜¯ä¸æ˜¯ç‰¹åˆ«å¥½çš„æ–¹æ¡ˆï¼Œæˆ‘æƒ³è¦ä¸€é—¨æ‰§è¡Œé€Ÿåº¦ç›¸å¯¹è¾ƒå¿«ï¼Œè¯­æ³•å¯¹å†™ç¼–è¯‘å™¨ç›¸å¯¹å‹å¥½çš„è¯­è¨€ã€‚Scala å·²ç»å¾ˆæ¥è¿‘äº†ï¼Œä½†æ˜¯è¿˜ä¸å¤Ÿã€‚è¿™è®©æˆ‘æƒ³èµ·ä¹‹å‰ç”¨è¿‡ OCaml æ¥å†™è¿‡ç¼–è¯‘å™¨ï¼Œæ„Ÿè§‰ä»£æ•°å½¢å¼çš„æ•°æ®ç»“æ„å¤©ç”Ÿå¯¹ç¼–è¯‘å™¨å’Œé™æ€åˆ†æéå¸¸å‹å¥½ã€‚è€Œä¸”æœ‰ä¸¤ä¸ªé¡¹ç›®éå¸¸å¯å‘åˆ°æˆ‘ï¼š</p>\n<ul>\n<li><strong><a href=\"https://flow.org/\">Flow</a></strong>ï¼šé™æ€åˆ†æå·¥å…·ï¼Œä½†æ˜¯å·²ç»æ¼”åŒ–åˆ°ç±»ä¼¼ TypeScript é‚£æ ·ï¼Œå˜æˆä¸€é—¨è¯­è¨€äº†ã€‚æˆ‘ä¸ªäººç”¨è¿‡ flowï¼Œä½†æ˜¯æ„Ÿè§‰éå¸¸æ…¢ï¼Œæ¯” TypeScript æ…¢å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä¸æ˜¯ OCaml æ…¢ï¼Œè€Œæ˜¯ flow æœ¬èº«è®¾è®¡çš„é—®é¢˜ã€‚è®¾è®¡ TypeScript çš„ Anders Hejlsberg æ¯•ç«Ÿæ˜¯ç¼–è¯‘å™¨é¢†åŸŸçš„å¤§ç‰›ï¼Œå¾ˆå¤šå‘éƒ½è¸©è¿‡ï¼Œåƒ TypeScript å’Œ VSCode è”åŠ¨ä½“éªŒè¿™ä¹ˆå¥½è‚¯å®šæ˜¯ç»è¿‡ä¼˜è‰¯è®¾è®¡çš„ã€‚</li>\n<li><strong><a href=\"https://bucklescript.github.io\">BuckleScript</a></strong>ï¼šæŠŠ OCaml ç¼–è¯‘åˆ° JS çš„ç¼–è¯‘å™¨ï¼ˆå…¶å®ä¹Ÿç®—ä¸€é—¨è¯­è¨€ï¼Ÿï¼‰ã€‚ä½œè€…å·ç§°ç¼–è¯‘é€Ÿåº¦æœ€å¿«çš„è¯­è¨€ï¼Œç¼–è¯‘é€Ÿåº¦æ¯” TypeScript è¿˜å¿«ï¼Œå¹¶é™„ä¸Šäº† benchmarkã€‚è¿™ç‚¹ä¹Ÿå¯ä»¥ç†è§£ã€‚æ¯•ç«Ÿ OCaml è¿™é—¨è¯­è¨€æ¯” TypeScript ç®€å•å¤ªå¤šäº†ã€‚è¿™è®©æˆ‘çœ‹åˆ°äº†ä¸€çº¿ç”Ÿæœºï¼ŒOCaml å†™å‡ºæ¥çš„ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥å¾ˆå¿«çš„å•Šã€‚</li>\n</ul>\n<h2>ä¼˜ç‚¹ï¼š</h2>\n<ul>\n<li>ADT</li>\n<li>å†·å¯åŠ¨é€Ÿåº¦å´å¯ä»¥ç§’æ€ Scalaã€‚æƒ³è±¡ä¸€ä¸‹ç¼–è¯‘å‡ ä¸ªæ–‡ä»¶çš„é¡¹ç›®ï¼ŒScala è¿˜è¦ç­‰ JVM é¢„çƒ­æ‰èƒ½è¾¾åˆ°å³°å€¼ï¼Œå…¶å®å¾ˆè›‹ç–¼ã€‚</li>\n<li>ç¼–è¯‘é€Ÿåº¦å¾ˆå¿«ï¼ˆç›¸æ¯” Scalaï¼‰</li>\n</ul>\n<h2>ç¼ºç‚¹ï¼š</h2>\n<ul>\n<li>ç°åœ¨ OCaml ä¾ç„¶æ²¡æœ‰åŠæ³•å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„å¤šçº¿ç¨‹ï¼šæœ‰ GILã€‚è€Œæˆ‘è§‰å¾—è¿™ä¸æ˜¯ç—›ç‚¹ï¼Œè€Œä¸” multi-core OCaml å‡†å¤‡æ¨å‡ºäº†ï¼ˆ2020 å¹´ï¼Ÿï¼‰ã€‚</li>\n<li>å¦‚æœéœ€è¦å’Œ JS è”åŠ¨ï¼Œéœ€è¦ç¼–è¯‘æˆ JS</li>\n</ul>\n<h1>ä½¿ç”¨ Flow Parser</h1>\n<p><strong>Github:</strong> <a href=\"https://github.com/facebook/flow\">https://github.com/facebook/flow</a></p>\n<p>Flow æ˜¯åˆ©å™¨ã€‚</p>\n<p>è‡ªå·±ä»å¤´å¼€å§‹å†™ ES çš„ Parser æ˜¯ä¸å¤ªç°å®çš„ã€‚å¾ˆå¹¸è¿ flow å°±æä¾›äº†è¿™ä¹ˆä¸€ä¸ªå·¥å…·ã€‚Flow çš„ä»£ç ç»“æ„è¿˜æ˜¯è›®æ¸…æ™°ï¼Œæˆ‘ä¸€çœ‹é¡¹ç›®ç›®å½•åŸºæœ¬äº†è§£å„ä¸ªæ¨¡å—çš„ä½œç”¨ï¼Œè€Œ parser æ˜¯ä½œä¸ºç‹¬ç«‹çš„ä¸€éƒ¨åˆ†ï¼š<a href=\"https://github.com/facebook/flow/tree/master/src/parser\">Flow Parser</a></p>\n<p>AST å®šä¹‰ï¼š<a href=\"https://github.com/facebook/flow/blob/master/src/parser/flow_ast.ml\">https://github.com/facebook/flow/blob/master/src/parser/flow_ast.ml</a></p>\n<p>Flow çš„ AST éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ program çš„å®šä¹‰ï¼š</p>\n<pre><code class=\"language-ocaml\">type ('M, 'T) program = 'M * ('M, 'T) Statement.t list * 'M Comment.t list [@@deriving show]\n</code></pre>\n<p>ä¸€ä¸ª program å°±æ˜¯ <code>list of Statment.t</code>ã€‚æœ‰ä¸¤ä¸ªæ³›å‹å‚æ•° <code>'M</code> å’Œ <code>'T</code> å……æ–¥ç€æ•´ä¸ª ASTï¼Œè™½ç„¶å®ƒçš„ä½œç”¨å¾ˆå·§å¦™ï¼Œä½†æ˜¯å´å¹¶ä¸æ˜¯é‚£ä¹ˆç›´è§‚ã€‚å®é™…ä¸Š parser è¾“å‡ºçš„ç»“æœä¸­ï¼Œ<code>'M</code> å’Œ <code>'T</code> éƒ½æ˜¯ <code>Loc.t</code>ï¼Œå°±æ˜¯ AST çš„ä½ç½®ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªèŒƒå‹å‘¢ï¼Ÿæˆ‘ä»¬åªè¦çœ‹ <code>Statement</code> å’Œ <code>Expression</code> ä¸¤ä¸ªåœ°æ–¹çš„å®šä¹‰å°±æ˜ç™½äº†ï¼š</p>\n<p><strong>Statement</strong></p>\n<pre><code class=\"language-ocaml\">  and ('M, 'T) t = 'M * ('M, 'T) t'\n  and ('M, 'T) t' =\n    | Block of ('M, 'T) Block.t\n    | Break of 'M Break.t\n    | ClassDeclaration of ('M, 'T) Class.t\n    | Continue of 'M Continue.t\n    | Debugger\n    | DeclareClass of ('M, 'T) DeclareClass.t\n    | DeclareExportDeclaration of ('M, 'T) DeclareExportDeclaration.t\n    | DeclareFunction of ('M, 'T) DeclareFunction.t\n    | DeclareInterface of ('M, 'T) Interface.t\n    | DeclareModule of ('M, 'T) DeclareModule.t\n    | DeclareModuleExports of ('M, 'T) Type.annotation\n    | DeclareTypeAlias of ('M, 'T) TypeAlias.t\n    | DeclareOpaqueType of ('M, 'T) OpaqueType.t\n    | DeclareVariable of ('M, 'T) DeclareVariable.t\n    | DoWhile of ('M, 'T) DoWhile.t\n    | Empty\n    | ExportDefaultDeclaration of ('M, 'T) ExportDefaultDeclaration.t\n    | ExportNamedDeclaration of ('M, 'T) ExportNamedDeclaration.t\n    | Expression of ('M, 'T) Expression.t\n    | For of ('M, 'T) For.t\n    | ForIn of ('M, 'T) ForIn.t\n    | ForOf of ('M, 'T) ForOf.t\n    | FunctionDeclaration of ('M, 'T) Function.t\n    | If of ('M, 'T) If.t\n    | ImportDeclaration of ('M, 'T) ImportDeclaration.t\n    | InterfaceDeclaration of ('M, 'T) Interface.t\n    | Labeled of ('M, 'T) Labeled.t\n    | Return of ('M, 'T) Return.t\n    | Switch of ('M, 'T) Switch.t\n    | Throw of ('M, 'T) Throw.t\n    | Try of ('M, 'T) Try.t\n    | TypeAlias of ('M, 'T) TypeAlias.t\n    | OpaqueType of ('M, 'T) OpaqueType.t\n    | VariableDeclaration of ('M, 'T) VariableDeclaration.t\n    | While of ('M, 'T) While.t\n    | With of ('M, 'T) With.t\n</code></pre>\n<p><strong>Expression</strong></p>\n<pre><code class=\"language-ocaml\">  type ('M, 'T) t = 'T * ('M, 'T) t'\n  and ('M, 'T) t' =\n    | Array of ('M, 'T) Array.t\n    | ArrowFunction of ('M, 'T) Function.t\n    | Assignment of ('M, 'T) Assignment.t\n    | Binary of ('M, 'T) Binary.t\n    | Call of ('M, 'T) Call.t\n    | Class of ('M, 'T) Class.t\n    | Comprehension of ('M, 'T) Comprehension.t\n    | Conditional of ('M, 'T) Conditional.t\n    | Function of ('M, 'T) Function.t\n    | Generator of ('M, 'T) Generator.t\n    | Identifier of 'T Identifier.t\n    | Import of ('M, 'T) t\n    | JSXElement of ('M, 'T) JSX.element\n    | JSXFragment of ('M, 'T) JSX.fragment\n    | Literal of Literal.t\n    | Logical of ('M, 'T) Logical.t\n    | Member of ('M, 'T) Member.t\n    | MetaProperty of 'M MetaProperty.t\n    | New of ('M, 'T) New.t\n    | Object of ('M, 'T) Object.t\n    | OptionalCall of ('M, 'T) OptionalCall.t\n    | OptionalMember of ('M, 'T) OptionalMember.t\n    | Sequence of ('M, 'T) Sequence.t\n    | Super\n    | TaggedTemplate of ('M, 'T) TaggedTemplate.t\n    | TemplateLiteral of ('M, 'T) TemplateLiteral.t\n    | This\n    | TypeCast of ('M, 'T) TypeCast.t\n    | Unary of ('M, 'T) Unary.t\n    | Update of ('M, 'T) Update.t\n    | Yield of ('M, 'T) Yield.t\n</code></pre>\n<p>ä¸Šè¿°ä»£ç å°±æ˜¯åœ¨è¯´ï¼Œæ‰€æœ‰çš„ Expression ç»“ç‚¹éƒ½ä¼šé™„ä¸Šä¸€ä¸ª <code>'T</code> ä¿¡æ¯ï¼Œæ‰€æœ‰çš„ Statement éƒ½ä¼šé™„ä¸Šä¸€ä¸ª <code>'M</code> ä¿¡æ¯ï¼Œè¿™å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªèŒƒå‹æ˜¯ç”¨æ¥åŒºåˆ† Statement å’Œ Expression çš„ã€‚åœ¨ flow é‡Œé¢è¿›è¡Œ type infer å’Œ type check çš„æ—¶å€™ï¼Œå®é™…ä¸Š <code>'T</code> ä¼šæ˜¯ <code>(Loc.t * Type.t)</code>ã€‚è¿™ä¸ªæ˜¯ type check é˜¶æ®µé™„ä¸Šçš„ä¿¡æ¯ï¼Œè€Œ Statement ä¸éœ€è¦è¿™ä¸ªä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒä»ç„¶æ˜¯ <code>Loc.t</code>ã€‚ä¸¾ä¸ªç±»å‹æ¨å¯¼ä¾‹å­ ğŸŒ° æ¥è¯´æ˜ 'T é™„åœ¨è¡¨è¾¾å¼ä¸Šçš„ä½œç”¨ï¼š</p>\n<pre><code>var a = 1 + 1;\n\nvar a = ((1: 'T) + (1: 'T)): 'T\nvar a = ((1: number) + (1: number)): 'T\nvar a = ((1: number) + (1: number)): number\nvar a: number = ((1: number) + (1: number)): number\n</code></pre>\n<p>ä»ä¸Šè¿°è¿‡ç¨‹å¯ä»¥æ¨å‡º a çš„ç±»å‹æ˜¯ numberï¼Œè¿™ä¸ªç±»å‹ä¿¡æ¯æŒ‚åœ¨æ‰€æœ‰ expression çš„ AST çš„ä¸Šé¢ï¼Œè€Œ var è¯­å¥çš„ node ä¸éœ€è¦è¿™ä¸ªä¿¡æ¯ã€‚</p>\n<h1>å®‰è£… Flow Parser</h1>\n<p>åŸæœ¬ <code>flow_parser</code> å¯ä»¥ä» opam å®‰è£…ï¼Œä½†æ˜¯æˆ‘æ›´æ–°äº† opam ä¹‹åä¼¼ä¹å› ä¸ºä¸€äº›å®‰å…¨ç­–ç•¥ç¦æ­¢åŒ…é‡Œé¢çš„ bash è„šæœ¬æ‰§è¡Œï¼ˆå½“æ—¶ç¤¾åŒºå‘ç”Ÿäº†ä¸€ä»¶äº‹ï¼Œä¸€ä¸ªåŒ…çš„ bash è„šæœ¬æŠŠç”¨æˆ·çš„æ•´ä¸ª ~ ç›®å½•åˆ æ‰ï¼Œä¼¼ä¹æ˜¯æ‰‹æ»‘å†™çš„è„šæœ¬å°±å‘å¸ƒäº†ï¼Œåæ¥ opam å¯¹ bash è„šæœ¬åšäº†äº›é™åˆ¶ï¼‰ã€‚æ‰€ä»¥åæ¥æˆ‘åªèƒ½ clone äº† flow çš„ä»£ç æœ¬åœ°è¿›è¡Œå®‰è£…</p>\n<p>è¿›å…¥ <code>src/parser</code> ç›®å½•æ‰§è¡Œï¼š</p>\n<pre><code class=\"language-bash\">$ make ocamlfind-install\n</code></pre>\n<p>å³å¯å®‰è£…æˆåŠŸã€‚å¦‚æœä½¿ç”¨ ocamlbuild ç¼–è¯‘ï¼Œè¿›å…¥ <code>_tag</code> æ–‡ä»¶ï¼ŒåŠ ä¸Š flow<em>parserã€‚æˆ‘çš„ `</em>tag`:</p>\n<pre><code>true: package(ppx_deriving.show), package(flow_parser), package(core_kernel)\n&#x3C;dist>: -traverse\n</code></pre>\n<h1>ä½¿ç”¨æ–¹æ³•</h1>\n<p>ä½¿ç”¨ <code>Flow_ast</code> è‡ªå¸¦çš„ <code>pp</code> å’Œ <code>show</code> æ–¹æ³•å¯ä»¥æŠŠ AST æ‰“å°å‡ºæ¥ï¼Œå‰ææ˜¯ä½ è¦ä¼ å…¥ <code>'T</code> å’Œ <code>'M</code> çš„ pretty print æ–¹æ³•ï¼Œ è¿™é‡Œæˆ‘æŠŠ <code>Loc.pp</code> ä¼ è¿›å»å³å¯ï¼š</p>\n<pre><code class=\"language-ocaml\">let ast, _ = Parser_flow.program code in\nFlow_ast.show_program Loc.pp Loc.pp ast |> print_endline;\n</code></pre>\n<p>å¤§åŠŸå‘Šæˆï¼</p>\n<h1>ç›¸å…³é˜…è¯»</h1>\n<ul>\n<li>QuickJS æºç è§£è¯»ï¼š<a href=\"https://diverse.space/2019/08/understanding-source-code-of-quickjs-1\">https://diverse.space/2019/08/understanding-source-code-of-quickjs-1</a></li>\n</ul>","frontmatter":{"date":"2019-02-20","path":"/2019/02/parse-javascript-with-ocaml","title":"ä½¿ç”¨ OCaml è§£æ JavaScript","permalink":null,"headerImage":null,"tags":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"ä½¿ç”¨ OCaml è§£æ JavaScript"}}}